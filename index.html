<!DOCTYPE html>
<!-- BUILD_VERSION: 2026-01-31-v2 - Number fix included -->
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI War Room - Veille Concurrentielle Gaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f0f1a', 800: '#1a1a2e', 700: '#252540', 600: '#2d2d4a' },
                        accent: { blue: '#3b82f6', green: '#10b981', red: '#ef4444', yellow: '#f59e0b', purple: '#8b5cf6' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f0f1a; }
        .glass { background: rgba(26, 26, 46, 0.8); backdrop-filter: blur(10px); }
        .status-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="text-white min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect } = React;

// ===== VRAIS CONCURRENTS =====
const comparators = [
    {
        id: 1,
        name: 'AllKeyShop',
        domain: 'allkeyshop.com',
        logo: 'ðŸ”µ',
        type: 'comparator',
        status: 'active',
        sitemapUrl: 'https://www.allkeyshop.com/blog/sitemap_index.xml',
        lastCheck: '30 Jan 2026, 16:45',
        pagesIndexed: 847523,
        newPages24h: 234,
        threat: 'high',
        notes: 'Leader historique, trÃ¨s agressif sur le SEO, cashback system'
    },
    {
        id: 2,
        name: 'GG.deals',
        domain: 'gg.deals',
        logo: 'ðŸŸ¢',
        type: 'comparator',
        status: 'active',
        sitemapUrl: 'https://gg.deals/sitemap.xml',
        lastCheck: '30 Jan 2026, 16:42',
        pagesIndexed: 623847,
        newPages24h: 412,
        threat: 'high',
        notes: 'Croissance rapide, UI moderne, systÃ¨me alertes prix, API'
    },
    {
        id: 3,
        name: 'IsThereAnyDeal',
        domain: 'isthereanydeal.com',
        logo: 'ðŸŸ¡',
        type: 'comparator',
        status: 'active',
        sitemapUrl: 'https://isthereanydeal.com/sitemap.xml',
        lastCheck: '30 Jan 2026, 16:40',
        pagesIndexed: 234156,
        newPages24h: 89,
        threat: 'medium',
        notes: 'Focus stores officiels, intÃ©gration Steam, wishlist sync'
    },
    {
        id: 4,
        name: 'CheapShark',
        domain: 'cheapshark.com',
        logo: 'ðŸ¦ˆ',
        type: 'comparator',
        status: 'active',
        sitemapUrl: 'https://www.cheapshark.com/sitemap.xml',
        lastCheck: '30 Jan 2026, 16:38',
        pagesIndexed: 156234,
        newPages24h: 45,
        threat: 'low',
        notes: 'API publique trÃ¨s utilisÃ©e, communautÃ© dev, US-focused'
    },
    {
        id: 5,
        name: 'DLCompare',
        domain: 'dlcompare.com',
        logo: 'ðŸ”´',
        type: 'comparator',
        status: 'active',
        sitemapUrl: 'https://www.dlcompare.com/sitemap.xml',
        lastCheck: '30 Jan 2026, 16:35',
        pagesIndexed: 312456,
        newPages24h: 67,
        threat: 'medium',
        notes: 'Fort en France/Europe, multilingue, bon SEO local'
    },
];

const merchants = [
    { id: 1, name: 'CDKeys', domain: 'cdkeys.com', logo: 'ðŸ”‘', status: 'active', reliability: 94, lastPromo: 'WINTER25 -25%', threat: 'medium', inventory: 12453, premiumProgram: null, affiliateRate: '5%', paymentMethods: 5, trustpilot: 4.6, foundedYear: 2012 },
    { id: 2, name: 'Instant Gaming', domain: 'instant-gaming.com', logo: 'âš¡', status: 'active', reliability: 87, lastPromo: '10% cashback new users', threat: 'high', inventory: 18234, premiumProgram: null, affiliateRate: '7%', paymentMethods: 8, trustpilot: 4.5, foundedYear: 2012 },
    { id: 3, name: 'G2A', domain: 'g2a.com', logo: 'ðŸª', status: 'active', reliability: 58, lastPromo: 'G2A Plus -10%', threat: 'high', inventory: 45678, premiumProgram: '1.99â‚¬/mois', affiliateRate: '10%', paymentMethods: 12, trustpilot: 4.0, foundedYear: 2010 },
    { id: 4, name: 'Kinguin', domain: 'kinguin.net', logo: 'ðŸ‘‘', status: 'active', reliability: 42, lastPromo: 'Flash Sale -40%', threat: 'medium', inventory: 23456, premiumProgram: '4.99â‚¬/mois', affiliateRate: '8%', paymentMethods: 6, trustpilot: 3.8, foundedYear: 2013 },
    { id: 5, name: 'Eneba', domain: 'eneba.com', logo: 'ðŸ›’', status: 'active', reliability: 71, lastPromo: 'ENEBA5 -5%', threat: 'high', inventory: 34567, premiumProgram: null, affiliateRate: '6%', paymentMethods: 10, trustpilot: 4.3, foundedYear: 2018 },
    { id: 6, name: 'Fanatical', domain: 'fanatical.com', logo: 'ðŸŽ¯', status: 'active', reliability: 89, lastPromo: 'Build your bundle', threat: 'low', inventory: 8765, premiumProgram: null, affiliateRate: '8%', paymentMethods: 4, trustpilot: 4.7, foundedYear: 2012 },
    { id: 7, name: 'Gamesplanet', domain: 'gamesplanet.com', logo: 'ðŸŒ', status: 'active', reliability: 91, lastPromo: 'Weekend deals', threat: 'low', inventory: 6543, premiumProgram: null, affiliateRate: '5%', paymentMethods: 5, trustpilot: 4.8, foundedYear: 2006 },
    { id: 8, name: 'HRK Game', domain: 'hrkgame.com', logo: 'ðŸŽ®', status: 'active', reliability: 65, lastPromo: 'New user -15%', threat: 'low', inventory: 9876, premiumProgram: null, affiliateRate: '4%', paymentMethods: 5, trustpilot: 4.1, foundedYear: 2014 },
    { id: 9, name: 'Gamivo', domain: 'gamivo.com', logo: 'ðŸŽª', status: 'active', reliability: 68, lastPromo: 'Smart price', threat: 'medium', inventory: 19876, premiumProgram: '1.29â‚¬/mois', affiliateRate: '7%', paymentMethods: 8, trustpilot: 4.2, foundedYear: 2016 },
    { id: 10, name: 'Green Man Gaming', domain: 'greenmangaming.com', logo: 'ðŸŸ©', status: 'active', reliability: 95, lastPromo: 'VIP -22%', threat: 'low', inventory: 4567, premiumProgram: 'Gratuit (XP)', affiliateRate: '5%', paymentMethods: 6, trustpilot: 4.6, foundedYear: 2010 },
];

// ===== NEWS FEED DATA (fetched from real RSS) =====
// Placeholder - will be fetched dynamically from /api/news-rss
let newsFeeds = [];

// ===== DISCORD FEATURE ANNOUNCEMENTS (fetched from Discord) =====
// Placeholder - will be fetched dynamically from /api/discord-feed
let discordFeatures = [];

// API base URL
const API_BASE = window.location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : 'https://competitive-intelligence-pearl.vercel.app';

// Check if demo mode is enabled
function isDemoMode() {
    return localStorage.getItem('ci_demo_mode') === 'true';
}

// Check if a comparator is being tracked (enabled in settings)
function isComparatorTracked(compName) {
    const saved = localStorage.getItem('ci_comparator_tracking');
    if (!saved) return true; // Default: all enabled
    const tracking = JSON.parse(saved);
    return tracking[compName] !== false;
}

// Sample demo data for News Checker
const demoNews = [
    { id: 'demo-1', source: 'GG.deals', logo: 'ðŸŸ¢', title: '[DEMO] Steam Winter Sale 2026 - Meilleures offres', url: 'https://gg.deals/news/', description: 'Les meilleures rÃ©ductions de la vente d\'hiver Steam', category: 'sale', publishedAt: new Date().toISOString() },
    { id: 'demo-2', source: 'AllKeyShop', logo: 'ðŸ”µ', title: '[DEMO] Top 10 Jeux PS5 moins chers', url: 'https://allkeyshop.com/', description: 'Comparaison des prix pour les hits PS5', category: 'comparison', publishedAt: new Date(Date.now() - 86400000).toISOString() },
    { id: 'demo-3', source: 'IsThereAnyDeal', logo: 'ðŸŸ¡', title: '[DEMO] Humble Bundle Choice FÃ©vrier 2026', url: 'https://isthereanydeal.com/', description: 'Analyse du nouveau bundle mensuel', category: 'bundle', publishedAt: new Date(Date.now() - 172800000).toISOString() },
    { id: 'demo-4', source: 'GG.deals', logo: 'ðŸŸ¢', title: '[DEMO] EA Play rejoint le Game Pass', url: 'https://gg.deals/news/', description: 'Nouvelle intÃ©gration entre services', category: 'news', publishedAt: new Date(Date.now() - 259200000).toISOString() },
    { id: 'demo-5', source: 'AllKeyShop', logo: 'ðŸ”µ', title: '[DEMO] Guide: Eviter les arnaques sur les marketplaces', url: 'https://allkeyshop.com/', description: 'Conseils pour acheter en sÃ©curitÃ©', category: 'guide', publishedAt: new Date(Date.now() - 345600000).toISOString() },
];

// Sample demo data for Feature Tracker
const demoFeatures = [
    { id: 'demo-f1', title: '[DEMO] GG.deals lance un comparateur de bundles', description: 'Nouveau systÃ¨me pour comparer les bundles', status: 'released', announcedAt: '2026-01-30', impact: 'high', source: 'GG.deals' },
    { id: 'demo-f2', title: '[DEMO] AllKeyShop: Nouveau systÃ¨me de cashback', description: 'Programme de fidÃ©litÃ© Ã©tendu', status: 'beta', announcedAt: '2026-01-28', impact: 'medium', source: 'AllKeyShop' },
    { id: 'demo-f3', title: '[DEMO] DLCompare refonte mobile', description: 'Application mobile totalement redessinÃ©e', status: 'announced', announcedAt: '2026-01-25', impact: 'high', source: 'DLCompare' },
    { id: 'demo-f4', title: '[DEMO] IsThereAnyDeal: IntÃ©gration GOG Galaxy', description: 'Sync wishlist avec GOG Galaxy', status: 'in-progress', announcedAt: '2026-01-20', impact: 'medium', source: 'IsThereAnyDeal' },
];

// Fetch real news from RSS API
async function fetchNewsFeeds() {
    // Return demo data if demo mode is enabled
    if (isDemoMode()) {
        return demoNews;
    }

    try {
        const response = await fetch(`${API_BASE}/api/news-rss`);
        if (response.ok) {
            const data = await response.json();
            return data.articles || [];
        }
    } catch (error) {
        console.error('Error fetching news RSS:', error);
    }
    return [];
}

// Fetch real Discord announcements
async function fetchDiscordFeatures() {
    // Return demo data if demo mode is enabled
    if (isDemoMode()) {
        return demoFeatures;
    }

    try {
        const response = await fetch(`${API_BASE}/api/discord-feed`);
        if (response.ok) {
            const data = await response.json();
            return (data.announcements || []).map(a => ({
                id: a.id,
                title: a.title,
                description: a.description,
                status: a.status || 'announced',
                announcedAt: a.timestamp ? a.timestamp.split('T')[0] : new Date().toISOString().split('T')[0],
                discordLink: a.url,
                impact: a.impact || 'medium',
                source: a.source
            }));
        }
    } catch (error) {
        console.error('Error fetching Discord feed:', error);
    }
    return [];
}

// Alertes rÃ©centes rÃ©alistes
// Alertes - seront gÃ©nÃ©rÃ©es automatiquement par Sitemap Checker, Status Checker, et News Checker
// Plus de fake data - les alertes apparaÃ®tront quand les checkers dÃ©tecteront des changements
const recentAlerts = [];

// DonnÃ©es price checker
const gamePrices = {
    'GTA VI': [
        { merchant: 'CDKeys', price: 59.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Instant Gaming', price: 54.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'G2A', price: 52.50, currency: 'EUR', inStock: true, region: 'Global' },
        { merchant: 'Kinguin', price: 55.99, currency: 'EUR', inStock: false, region: 'EU' },
        { merchant: 'Eneba', price: 53.20, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Fanatical', price: 59.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Green Man Gaming', price: 59.99, currency: 'EUR', inStock: true, region: 'EU' },
    ],
    'EA FC 25': [
        { merchant: 'CDKeys', price: 45.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Instant Gaming', price: 44.50, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'G2A', price: 42.30, currency: 'EUR', inStock: true, region: 'Global' },
        { merchant: 'Eneba', price: 41.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Gamivo', price: 43.50, currency: 'EUR', inStock: true, region: 'EU' },
    ],
    'Elden Ring': [
        { merchant: 'CDKeys', price: 35.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Instant Gaming', price: 34.50, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'G2A', price: 32.80, currency: 'EUR', inStock: true, region: 'Global' },
        { merchant: 'Fanatical', price: 37.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Green Man Gaming', price: 39.99, currency: 'EUR', inStock: true, region: 'EU' },
    ],
    'Cyberpunk 2077': [
        { merchant: 'CDKeys', price: 24.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Instant Gaming', price: 22.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'G2A', price: 21.50, currency: 'EUR', inStock: true, region: 'Global' },
        { merchant: 'Eneba', price: 23.50, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Kinguin', price: 25.99, currency: 'EUR', inStock: true, region: 'EU' },
    ],
    'Hogwarts Legacy': [
        { merchant: 'CDKeys', price: 32.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Instant Gaming', price: 31.50, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Fanatical', price: 34.99, currency: 'EUR', inStock: true, region: 'EU' },
        { merchant: 'Gamesplanet', price: 35.99, currency: 'EUR', inStock: true, region: 'EU' },
    ],
};

// Generate dynamic sitemap history based on comparators
function generateSitemapHistory() {
    const days = ['30 Jan', '29 Jan', '28 Jan', '27 Jan', '26 Jan', '25 Jan', '24 Jan'];
    return days.map((date, dayIndex) => {
        const row = { date };
        comparators.forEach(comp => {
            // Use comparator's pagesIndexed as base, decrease slightly for older days
            const basePages = comp.pagesIndexed || 100000;
            const variance = Math.floor(basePages * 0.001 * dayIndex); // ~0.1% decrease per day
            row[comp.name.toLowerCase().replace(/[^a-z0-9]/g, '')] = basePages - variance;
        });
        return row;
    });
}
const sitemapHistory = generateSitemapHistory();

// ===== STATUS CHECKER DATA (REAL URLs) =====
const serviceStatus = {
    'AllKeyShop': {
        logo: 'ðŸ”µ',
        domain: 'allkeyshop.com',
        services: [
            { name: 'Main Website', url: 'https://www.allkeyshop.com/blog/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Reward Program', url: 'https://www.allkeyshop.com/blog/reward-program/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Vouchers Page', url: 'https://www.allkeyshop.com/blog/vouchers/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Games Catalog', url: 'https://www.allkeyshop.com/blog/games/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Gift Cards', url: 'https://www.allkeyshop.com/blog/catalogue/category-giftcards/', status: 'online', lastCheck: null, responseTime: null },
        ],
        merchantVouchers: [
            { merchant: 'PremiumCDkeys', url: 'https://www.allkeyshop.com/blog/vouchers/premiumcdkeys/', status: 'pending', lastCheck: null },
            { merchant: 'Keys4us', url: 'https://www.allkeyshop.com/blog/vouchers/keys4us/', status: 'pending', lastCheck: null },
            { merchant: '2Game', url: 'https://www.allkeyshop.com/blog/vouchers/2game/', status: 'pending', lastCheck: null },
            { merchant: 'Driffle', url: 'https://www.allkeyshop.com/blog/vouchers/driffle/', status: 'pending', lastCheck: null },
            { merchant: 'Gamivo', url: 'https://www.allkeyshop.com/blog/vouchers/gamivo/', status: 'pending', lastCheck: null },
            { merchant: 'K4G', url: 'https://www.allkeyshop.com/blog/vouchers/k4g/', status: 'pending', lastCheck: null },
            { merchant: 'Eneba', url: 'https://www.allkeyshop.com/blog/vouchers/eneba/', status: 'pending', lastCheck: null },
            { merchant: 'HRK', url: 'https://www.allkeyshop.com/blog/vouchers/hrk/', status: 'pending', lastCheck: null },
            { merchant: 'Kinguin', url: 'https://www.allkeyshop.com/blog/vouchers/kinguin/', status: 'pending', lastCheck: null },
            { merchant: 'GAMESEAL', url: 'https://www.allkeyshop.com/blog/vouchers/gameseal/', status: 'pending', lastCheck: null },
            { merchant: 'BuyGames', url: 'https://www.allkeyshop.com/blog/vouchers/buygames/', status: 'pending', lastCheck: null },
            { merchant: 'Bitcodes', url: 'https://www.allkeyshop.com/blog/vouchers/bitcodes/', status: 'pending', lastCheck: null },
        ]
    },
    'GG.deals': {
        logo: 'ðŸŸ¢',
        domain: 'gg.deals',
        services: [
            { name: 'Main Website', url: 'https://gg.deals/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Deals Page', url: 'https://gg.deals/deals/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Games', url: 'https://gg.deals/games/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Vouchers', url: 'https://gg.deals/vouchers/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'News', url: 'https://gg.deals/news/', status: 'online', lastCheck: null, responseTime: null },
        ],
        merchantVouchers: [
            { merchant: 'Kinguin', url: 'https://gg.deals/vouchers/kinguin/', status: 'pending', lastCheck: null },
            { merchant: 'Driffle', url: 'https://gg.deals/vouchers/driffle/', status: 'pending', lastCheck: null },
            { merchant: 'G2A', url: 'https://gg.deals/vouchers/g2a/', status: 'pending', lastCheck: null },
            { merchant: 'GAMIVO', url: 'https://gg.deals/vouchers/gamivo/', status: 'pending', lastCheck: null },
            { merchant: 'K4G', url: 'https://gg.deals/vouchers/k4g/', status: 'pending', lastCheck: null },
            { merchant: 'CDKeys', url: 'https://gg.deals/vouchers/cdkeys/', status: 'pending', lastCheck: null },
            { merchant: 'Yuplay', url: 'https://gg.deals/vouchers/yuplay/', status: 'pending', lastCheck: null },
            { merchant: 'Green Man Gaming', url: 'https://gg.deals/vouchers/green-man-gaming/', status: 'pending', lastCheck: null },
        ]
    },
    'IsThereAnyDeal': {
        logo: 'ðŸŸ¡',
        domain: 'isthereanydeal.com',
        services: [
            { name: 'Main Website', url: 'https://isthereanydeal.com/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Deals', url: 'https://isthereanydeal.com/deals/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Specials', url: 'https://isthereanydeal.com/specials/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Giveaways', url: 'https://isthereanydeal.com/giveaways/', status: 'online', lastCheck: null, responseTime: null },
        ],
        merchantVouchers: []
    },
    'CheapShark': {
        logo: 'ðŸ¦ˆ',
        domain: 'cheapshark.com',
        services: [
            { name: 'Main Website', url: 'https://www.cheapshark.com/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Deals API', url: 'https://www.cheapshark.com/api/1.0/deals', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Stores API', url: 'https://www.cheapshark.com/api/1.0/stores', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Games API', url: 'https://www.cheapshark.com/api/1.0/games', status: 'online', lastCheck: null, responseTime: null },
        ],
        merchantVouchers: []
    },
    'DLCompare': {
        logo: 'ðŸ”´',
        domain: 'dlcompare.fr',
        services: [
            { name: 'Main Website', url: 'https://www.dlcompare.fr/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Jeux PC', url: 'https://www.dlcompare.fr/jeux-pc/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'Bons Plans', url: 'https://www.dlcompare.fr/bons-plans/', status: 'online', lastCheck: null, responseTime: null },
            { name: 'ActualitÃ©s', url: 'https://www.dlcompare.fr/actualites/', status: 'online', lastCheck: null, responseTime: null },
        ],
        merchantVouchers: []
    }
};

// Discord webhook configuration
const discordConfig = {
    enabled: true,
    webhookUrl: '',
    channels: {
        alerts: true,
        priceDrops: true,
        statusChanges: true,
        dailyReport: false
    }
};

// ===== COMPOSANTS =====

// Modal d'Ã©dition rÃ©utilisable
function EditModal({ isOpen, onClose, title, children, onSave }) {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
            <div className="bg-dark-800 rounded-xl border border-dark-600 w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between p-4 border-b border-dark-600">
                    <h3 className="font-bold text-lg">{title}</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-white">
                        <i className="fas fa-times"></i>
                    </button>
                </div>
                <div className="p-4">{children}</div>
                <div className="flex justify-end space-x-2 p-4 border-t border-dark-600">
                    <button onClick={onClose} className="px-4 py-2 bg-gray-600 rounded-lg hover:bg-gray-500">Annuler</button>
                    <button onClick={onSave} className="px-4 py-2 bg-accent-blue rounded-lg hover:bg-blue-600">Sauvegarder</button>
                </div>
            </div>
        </div>
    );
}

function App() {
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [selectedGame, setSelectedGame] = useState('GTA VI');

    // Gestion des alertes dismissÃ©es (persistÃ©es dans localStorage)
    const [dismissedAlerts, setDismissedAlerts] = useState(() => {
        try {
            const saved = localStorage.getItem('ci_dismissed_alerts');
            return saved ? JSON.parse(saved) : [];
        } catch { return []; }
    });

    // Gestion des comparateurs (persistÃ©s dans localStorage)
    const [comparatorsData, setComparatorsData] = useState(() => {
        try {
            const saved = localStorage.getItem('ci_comparators');
            return saved ? JSON.parse(saved) : comparators;
        } catch { return comparators; }
    });

    // Gestion des marchands (persistÃ©s dans localStorage)
    const [merchantsData, setMerchantsData] = useState(() => {
        try {
            const saved = localStorage.getItem('ci_merchants');
            return saved ? JSON.parse(saved) : merchants;
        } catch { return merchants; }
    });

    // Alertes visibles (non dismissÃ©es)
    const visibleAlerts = recentAlerts.filter(a => !dismissedAlerts.includes(a.id));

    // Dismiss une alerte
    const dismissAlert = (alertId) => {
        const newDismissed = [...dismissedAlerts, alertId];
        setDismissedAlerts(newDismissed);
        localStorage.setItem('ci_dismissed_alerts', JSON.stringify(newDismissed));
    };

    // Clear toutes les alertes
    const clearAllAlerts = () => {
        const allIds = recentAlerts.map(a => a.id);
        setDismissedAlerts(allIds);
        localStorage.setItem('ci_dismissed_alerts', JSON.stringify(allIds));
    };

    // Reset alertes (tout rÃ©afficher)
    const resetAlerts = () => {
        setDismissedAlerts([]);
        localStorage.removeItem('ci_dismissed_alerts');
    };

    // CRUD Comparateurs
    const updateComparator = (id, data) => {
        const updated = comparatorsData.map(c => c.id === id ? { ...c, ...data } : c);
        setComparatorsData(updated);
        localStorage.setItem('ci_comparators', JSON.stringify(updated));
    };

    const addComparator = (data) => {
        const newId = Math.max(...comparatorsData.map(c => c.id), 0) + 1;
        const updated = [...comparatorsData, { ...data, id: newId }];
        setComparatorsData(updated);
        localStorage.setItem('ci_comparators', JSON.stringify(updated));
    };

    const deleteComparator = (id) => {
        const updated = comparatorsData.filter(c => c.id !== id);
        setComparatorsData(updated);
        localStorage.setItem('ci_comparators', JSON.stringify(updated));
    };

    // CRUD Marchands
    const updateMerchant = (id, data) => {
        const updated = merchantsData.map(m => m.id === id ? { ...m, ...data } : m);
        setMerchantsData(updated);
        localStorage.setItem('ci_merchants', JSON.stringify(updated));
    };

    const addMerchant = (data) => {
        const newId = Math.max(...merchantsData.map(m => m.id), 0) + 1;
        const updated = [...merchantsData, { ...data, id: newId }];
        setMerchantsData(updated);
        localStorage.setItem('ci_merchants', JSON.stringify(updated));
    };

    const deleteMerchant = (id) => {
        const updated = merchantsData.filter(m => m.id !== id);
        setMerchantsData(updated);
        localStorage.setItem('ci_merchants', JSON.stringify(updated));
    };

    // Reset data
    const resetData = (type) => {
        if (type === 'comparators') {
            setComparatorsData(comparators);
            localStorage.removeItem('ci_comparators');
        } else if (type === 'merchants') {
            setMerchantsData(merchants);
            localStorage.removeItem('ci_merchants');
        }
    };

    return (
        <div className="flex min-h-screen">
            <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} visibleAlerts={visibleAlerts} comparatorsData={comparatorsData} merchantsData={merchantsData} />
            <main className="flex-1 p-6 overflow-auto">
                {currentPage === 'dashboard' && <Dashboard setCurrentPage={setCurrentPage} visibleAlerts={visibleAlerts} comparatorsData={comparatorsData} merchantsData={merchantsData} />}
                {currentPage === 'comparators' && <ComparatorsPage data={comparatorsData} onUpdate={updateComparator} onAdd={addComparator} onDelete={deleteComparator} onReset={() => resetData('comparators')} />}
                {currentPage === 'merchants' && <MerchantsPage data={merchantsData} onUpdate={updateMerchant} onAdd={addMerchant} onDelete={deleteMerchant} onReset={() => resetData('merchants')} />}
                {currentPage === 'sitemap' && <SitemapChecker comparatorsData={comparatorsData} />}
                {currentPage === 'news-checker' && <NewsChecker />}
                {currentPage === 'feature-checker' && <FeatureChecker />}
                {currentPage === 'price-tracker' && <PriceTrackerPage />}
                {currentPage === 'coupon-tracker' && <CouponTrackerPage />}
                {currentPage === 'prices' && <PriceChecker selectedGame={selectedGame} setSelectedGame={setSelectedGame} />}
                {currentPage === 'status' && <StatusChecker />}
                {currentPage === 'alerts' && <AlertsPage visibleAlerts={visibleAlerts} dismissAlert={dismissAlert} clearAllAlerts={clearAllAlerts} resetAlerts={resetAlerts} />}
                {currentPage === 'settings' && <SettingsPage />}
            </main>
        </div>
    );
}

function Sidebar({ currentPage, setCurrentPage, visibleAlerts = [], comparatorsData = comparators, merchantsData = merchants }) {
    const alertCount = Object.values(serviceStatus).reduce((acc, site) => {
        const mainAlerts = site.services.filter(s => s.status === 'offline' || s.status === 'warning').length;
        const merchantAlerts = site.merchantVouchers.filter(m => m.status === 'offline' || m.status === 'warning').length;
        return acc + mainAlerts + merchantAlerts;
    }, 0);

    const highSeverityCount = visibleAlerts.filter(a => a.severity === 'high').length;

    const menuItems = [
        { id: 'dashboard', label: 'Dashboard', icon: 'fa-th-large' },
        { id: 'comparators', label: 'Comparateurs', icon: 'fa-balance-scale', count: comparatorsData.length },
        { id: 'merchants', label: 'Marchands', icon: 'fa-store', count: merchantsData.length },
        { id: 'sitemap', label: 'Sitemap Checker', icon: 'fa-sitemap' },
        { id: 'news-checker', label: 'News Checker', icon: 'fa-newspaper', badge: null }, // Dynamic - loaded from RSS API
        { id: 'feature-checker', label: 'Feature Tracker', icon: 'fa-rocket', badge: null }, // Dynamic - loaded from Discord API
        { id: 'price-tracker', label: 'RelevÃ©s Prix', icon: 'fa-clipboard-check', badge: null, tooltip: 'Saisir les relevÃ©s de prix (prix affichÃ© vs prix checkout) â†’ alimente TPA' },
        { id: 'coupon-tracker', label: 'RelevÃ©s Coupons', icon: 'fa-ticket-alt', badge: null, tooltip: 'Saisir les tests de coupons (valide/fake) â†’ alimente TPA' },
        { id: 'prices', label: 'Comparatif Prix', icon: 'fa-tags', tooltip: 'Vue comparative des prix par jeu (lecture seule)' },
        { id: 'status', label: 'Status Checker', icon: 'fa-heartbeat', badge: alertCount > 0 ? alertCount : null },
        { id: 'alerts', label: 'Alertes', icon: 'fa-bell', badge: highSeverityCount > 0 ? highSeverityCount : null },
        { id: 'settings', label: 'ParamÃ¨tres', icon: 'fa-cog' },
    ];

    return (
        <aside className="w-64 bg-dark-800 border-r border-dark-600 p-4 flex flex-col">
            <div className="flex items-center space-x-3 mb-8 px-2">
                <div className="w-10 h-10 bg-accent-blue rounded-lg flex items-center justify-center">
                    <i className="fas fa-crosshairs text-white"></i>
                </div>
                <div>
                    <div className="font-bold text-white">CI War Room</div>
                    <div className="text-xs text-gray-500">Gaming Keys Intel</div>
                </div>
            </div>

            <nav className="flex-1 space-y-1">
                {menuItems.map(item => (
                    <button
                        key={item.id}
                        onClick={() => setCurrentPage(item.id)}
                        title={item.tooltip || ''}
                        className={`w-full flex items-center justify-between px-4 py-3 rounded-lg transition ${
                            currentPage === item.id
                                ? 'bg-accent-blue text-white'
                                : 'text-gray-400 hover:bg-dark-700 hover:text-white'
                        }`}
                    >
                        <div className="flex items-center space-x-3">
                            <i className={`fas ${item.icon} w-5`}></i>
                            <span className="font-medium text-sm">{item.label}</span>
                            {item.tooltip && <i className="fas fa-info-circle text-xs opacity-50"></i>}
                        </div>
                        {item.badge && (
                            <span className="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">{item.badge}</span>
                        )}
                        {item.count && (
                            <span className="text-xs text-gray-500">{item.count}</span>
                        )}
                    </button>
                ))}
            </nav>

            <div className="mt-auto pt-4 border-t border-dark-600 space-y-3">
                {/* Download Addon */}
                <a
                    href="/extension/price-tracker-extension.zip"
                    download
                    className="flex items-center space-x-3 px-4 py-3 bg-gradient-to-r from-accent-blue/20 to-purple-500/20 rounded-lg border border-accent-blue/30 hover:border-accent-blue/50 transition group"
                >
                    <div className="w-8 h-8 bg-accent-blue/30 rounded-lg flex items-center justify-center group-hover:bg-accent-blue/50 transition">
                        <i className="fas fa-download text-accent-blue"></i>
                    </div>
                    <div>
                        <div className="text-sm font-medium text-white">Price Tracker Addon</div>
                        <div className="text-xs text-gray-400">Chrome Extension v1.0</div>
                    </div>
                </a>

                <div className="text-xs text-gray-600 px-4">
                    Scan: {new Date().toLocaleString('fr-FR', { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>
        </aside>
    );
}

function Dashboard({ setCurrentPage, visibleAlerts = [], comparatorsData = comparators, merchantsData = merchants }) {
    const totalPages = comparatorsData.reduce((sum, c) => sum + c.pagesIndexed, 0);
    const totalNew24h = comparatorsData.reduce((sum, c) => sum + c.newPages24h, 0);
    const highAlerts = visibleAlerts.filter(a => a.severity === 'high').length;

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Dashboard</h1>
                    <p className="text-gray-500">Veille concurrentielle - Comparateurs & Marchands de clÃ©s</p>
                </div>
                <button className="px-4 py-2 bg-accent-blue rounded-lg font-medium hover:bg-blue-600 transition flex items-center space-x-2">
                    <i className="fas fa-sync-alt"></i>
                    <span>Actualiser</span>
                </button>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-5 gap-4 mb-6">
                {[
                    { label: 'Comparateurs', value: comparatorsData.length, icon: 'fa-balance-scale', color: 'blue' },
                    { label: 'Marchands', value: merchantsData.length, icon: 'fa-store', color: 'green' },
                    { label: 'Pages indexÃ©es', value: (totalPages/1000000).toFixed(1) + 'M', icon: 'fa-file', color: 'purple' },
                    { label: 'Nouvelles 24h', value: '+' + totalNew24h, icon: 'fa-plus', color: 'yellow' },
                    { label: 'Alertes critiques', value: highAlerts, icon: 'fa-exclamation', color: 'red' },
                ].map((stat, i) => (
                    <div key={i} className="glass rounded-xl p-4 border border-dark-600">
                        <div className={`w-10 h-10 bg-accent-${stat.color}/20 rounded-lg flex items-center justify-center mb-3`}>
                            <i className={`fas ${stat.icon} text-accent-${stat.color}`}></i>
                        </div>
                        <div className="text-2xl font-bold">{stat.value}</div>
                        <div className="text-sm text-gray-500">{stat.label}</div>
                    </div>
                ))}
            </div>

            <div className="grid grid-cols-3 gap-6">
                {/* Alertes */}
                <div className="col-span-2 glass rounded-xl border border-dark-600 p-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="font-semibold flex items-center">
                            <i className="fas fa-bell text-accent-red mr-2"></i>
                            Alertes rÃ©centes
                        </h2>
                        <button onClick={() => setCurrentPage('alerts')} className="text-sm text-accent-blue hover:underline">
                            Tout voir â†’
                        </button>
                    </div>
                    <div className="space-y-2">
                        {visibleAlerts.length === 0 ? (
                            <div className="text-center py-6 text-gray-500">
                                <i className="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                                <p className="text-sm">Aucune alerte</p>
                                <p className="text-xs mt-1">Les alertes apparaÃ®tront via Sitemap Checker et Status Checker</p>
                            </div>
                        ) : (
                            visibleAlerts.slice(0, 6).map(alert => (
                                <div key={alert.id} className={`p-3 rounded-lg border-l-4 ${
                                    alert.severity === 'high' ? 'bg-red-500/10 border-red-500' :
                                    alert.severity === 'medium' ? 'bg-yellow-500/10 border-yellow-500' :
                                    'bg-gray-500/10 border-gray-500'
                                }`}>
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            <div className="flex items-center space-x-2 mb-1">
                                                <span className="font-medium text-sm">{alert.competitor}</span>
                                                <span className={`px-2 py-0.5 rounded text-xs ${
                                                    alert.type === 'price_drop' ? 'bg-green-500/20 text-green-400' :
                                                    alert.type === 'new_feature' ? 'bg-purple-500/20 text-purple-400' :
                                                    alert.type === 'sitemap' ? 'bg-blue-500/20 text-blue-400' :
                                                    alert.type === 'promo' ? 'bg-yellow-500/20 text-yellow-400' :
                                                    alert.type === 'seo' ? 'bg-orange-500/20 text-orange-400' :
                                                    'bg-gray-500/20 text-gray-400'
                                                }`}>{alert.type.replace('_', ' ')}</span>
                                            </div>
                                            <p className="text-sm text-gray-300">{alert.message}</p>
                                        </div>
                                        <span className="text-xs text-gray-500 ml-2">{alert.time}</span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>

                {/* Top menaces */}
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <h2 className="font-semibold mb-4 flex items-center">
                        <i className="fas fa-exclamation-triangle text-accent-yellow mr-2"></i>
                        Menaces prioritaires
                    </h2>
                    <div className="space-y-3">
                        {[...comparators, ...merchants].filter(c => c.threat === 'high').map(comp => (
                            <div key={comp.id + comp.name} className="flex items-center justify-between p-2 rounded-lg bg-dark-700/50 hover:bg-dark-700">
                                <div className="flex items-center space-x-3">
                                    <span className="text-xl">{comp.logo}</span>
                                    <div>
                                        <div className="font-medium text-sm">{comp.name}</div>
                                        <div className="text-xs text-gray-500">{comp.domain}</div>
                                    </div>
                                </div>
                                <span className="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded">HAUTE</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* Sitemap evolution */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h2 className="font-semibold mb-4 flex items-center">
                    <i className="fas fa-chart-line text-accent-blue mr-2"></i>
                    Ã‰volution pages indexÃ©es (7 jours)
                </h2>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead>
                            <tr className="text-gray-500 border-b border-dark-600">
                                <th className="text-left py-2 font-medium">Date</th>
                                {comparators.map(comp => (
                                    <th key={comp.id} className="text-right font-medium">{comp.logo} {comp.name}</th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {sitemapHistory.map((row, i) => (
                                <tr key={i} className="border-b border-dark-700/50">
                                    <td className="py-2 text-gray-400">{row.date}</td>
                                    {comparators.map(comp => {
                                        const key = comp.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                                        return <td key={comp.id} className="text-right font-mono">{(row[key] || 0).toLocaleString()}</td>;
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

function ComparatorsPage({ data = comparators, onUpdate, onAdd, onDelete, onReset }) {
    const [editingItem, setEditingItem] = useState(null);
    const [isAdding, setIsAdding] = useState(false);
    const [formData, setFormData] = useState({});

    const emptyForm = { name: '', domain: '', logo: 'ðŸ”µ', sitemapUrl: '', notes: '', threat: 'medium', pagesIndexed: 0, newPages24h: 0, lastCheck: new Date().toLocaleString('fr-FR') };

    const openEdit = (item) => {
        setFormData({ ...item });
        setEditingItem(item.id);
    };

    const openAdd = () => {
        setFormData({ ...emptyForm });
        setIsAdding(true);
    };

    const handleSave = () => {
        if (isAdding) {
            onAdd(formData);
            setIsAdding(false);
        } else {
            onUpdate(editingItem, formData);
            setEditingItem(null);
        }
    };

    const handleDelete = (id) => {
        if (confirm('Supprimer ce comparateur ?')) {
            onDelete(id);
        }
    };

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Comparateurs de prix</h1>
                    <p className="text-gray-500">{data.length} comparateurs surveillÃ©s</p>
                </div>
                <div className="flex space-x-2">
                    <button onClick={onReset} className="px-3 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 text-sm">
                        <i className="fas fa-undo mr-1"></i>Reset
                    </button>
                    <button onClick={openAdd} className="px-4 py-2 bg-accent-green rounded-lg hover:bg-green-600">
                        <i className="fas fa-plus mr-2"></i>Ajouter
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
                {data.map(comp => (
                    <div key={comp.id} className="glass rounded-xl border border-dark-600 p-5 group">
                        <div className="flex items-start justify-between mb-4">
                            <div className="flex items-center space-x-3">
                                <span className="text-3xl">{comp.logo}</span>
                                <div>
                                    <div className="font-bold text-lg">{comp.name}</div>
                                    <a href={`https://${comp.domain}`} target="_blank" className="text-sm text-accent-blue hover:underline">{comp.domain}</a>
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                    comp.threat === 'high' ? 'bg-red-500/20 text-red-400' :
                                    comp.threat === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                                    'bg-green-500/20 text-green-400'
                                }`}>
                                    {comp.threat === 'high' ? 'ðŸ”´' : comp.threat === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢'}
                                </span>
                                <button onClick={() => openEdit(comp)} className="opacity-0 group-hover:opacity-100 p-2 bg-dark-700 rounded-lg hover:bg-dark-600 transition">
                                    <i className="fas fa-edit text-sm text-gray-400"></i>
                                </button>
                                <button onClick={() => handleDelete(comp.id)} className="opacity-0 group-hover:opacity-100 p-2 bg-dark-700 rounded-lg hover:bg-red-500/20 transition">
                                    <i className="fas fa-trash text-sm text-red-400"></i>
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3 mb-4">
                            <div className="bg-dark-700 rounded-lg p-3 text-center">
                                <div className="text-xs text-gray-500">Pages indexÃ©es</div>
                                <div className="font-bold text-lg">{(comp.pagesIndexed/1000).toFixed(0)}k</div>
                            </div>
                            <div className="bg-dark-700 rounded-lg p-3 text-center">
                                <div className="text-xs text-gray-500">Nouvelles 24h</div>
                                <div className="font-bold text-lg text-green-400">+{comp.newPages24h}</div>
                            </div>
                        </div>

                        <p className="text-sm text-gray-400 mb-3">{comp.notes}</p>

                        <div className="flex items-center justify-between text-xs text-gray-500">
                            <span>Sitemap: <a href={comp.sitemapUrl} target="_blank" className="text-accent-blue hover:underline">Voir</a></span>
                            <span>Check: {comp.lastCheck}</span>
                        </div>
                    </div>
                ))}
            </div>

            {/* Edit/Add Modal */}
            <EditModal
                isOpen={editingItem !== null || isAdding}
                onClose={() => { setEditingItem(null); setIsAdding(false); }}
                title={isAdding ? 'Ajouter un comparateur' : 'Modifier le comparateur'}
                onSave={handleSave}
            >
                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Nom</label>
                            <input type="text" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Logo (emoji)</label>
                            <input type="text" value={formData.logo || ''} onChange={e => setFormData({...formData, logo: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Domaine</label>
                        <input type="text" value={formData.domain || ''} onChange={e => setFormData({...formData, domain: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" placeholder="example.com" />
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">URL Sitemap</label>
                        <input type="text" value={formData.sitemapUrl || ''} onChange={e => setFormData({...formData, sitemapUrl: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" placeholder="https://..." />
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Niveau de menace</label>
                        <select value={formData.threat || 'medium'} onChange={e => setFormData({...formData, threat: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none">
                            <option value="low">Faible</option>
                            <option value="medium">Moyenne</option>
                            <option value="high">Haute</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Notes</label>
                        <textarea value={formData.notes || ''} onChange={e => setFormData({...formData, notes: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" rows="3"></textarea>
                    </div>
                </div>
            </EditModal>
        </div>
    );
}

function MerchantsPage({ data = merchants, onUpdate, onAdd, onDelete, onReset }) {
    const [sortBy, setSortBy] = useState('reliability');
    const [sortDir, setSortDir] = useState('desc');
    const [editingItem, setEditingItem] = useState(null);
    const [isAdding, setIsAdding] = useState(false);
    const [formData, setFormData] = useState({});

    const emptyForm = { name: '', domain: '', logo: 'ðŸª', reliability: 50, trustpilot: 4.0, inventory: 1000, lastPromo: '', premiumProgram: null, affiliateRate: '5%', paymentMethods: 5, foundedYear: 2020, threat: 'medium' };

    const sortedMerchants = [...data].sort((a, b) => {
        const multiplier = sortDir === 'desc' ? -1 : 1;
        return (a[sortBy] - b[sortBy]) * multiplier;
    });

    const handleSort = (field) => {
        if (sortBy === field) {
            setSortDir(sortDir === 'desc' ? 'asc' : 'desc');
        } else {
            setSortBy(field);
            setSortDir('desc');
        }
    };

    const SortIcon = ({ field }) => (
        <i className={`fas fa-sort${sortBy === field ? (sortDir === 'desc' ? '-down' : '-up') : ''} ml-1 text-xs ${sortBy === field ? 'text-accent-blue' : 'text-gray-600'}`}></i>
    );

    const openEdit = (item) => {
        setFormData({ ...item });
        setEditingItem(item.id);
    };

    const openAdd = () => {
        setFormData({ ...emptyForm });
        setIsAdding(true);
    };

    const handleSave = () => {
        const parsedData = {
            ...formData,
            reliability: parseInt(formData.reliability) || 50,
            trustpilot: parseFloat(formData.trustpilot) || 4.0,
            inventory: parseInt(formData.inventory) || 1000,
            paymentMethods: parseInt(formData.paymentMethods) || 5,
            foundedYear: parseInt(formData.foundedYear) || 2020,
        };
        if (isAdding) {
            onAdd(parsedData);
            setIsAdding(false);
        } else {
            onUpdate(editingItem, parsedData);
            setEditingItem(null);
        }
    };

    const handleDelete = (id) => {
        if (confirm('Supprimer ce marchand ?')) {
            onDelete(id);
        }
    };

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Marchands de clÃ©s</h1>
                    <p className="text-gray-500">{data.length} marchands surveillÃ©s</p>
                </div>
                <div className="flex space-x-2">
                    <button onClick={onReset} className="px-3 py-2 bg-gray-600 rounded-lg hover:bg-gray-500 text-sm">
                        <i className="fas fa-undo mr-1"></i>Reset
                    </button>
                    <button onClick={openAdd} className="px-4 py-2 bg-accent-green rounded-lg hover:bg-green-600">
                        <i className="fas fa-plus mr-2"></i>Ajouter
                    </button>
                </div>
            </div>

            {/* Stats summary */}
            <div className="grid grid-cols-5 gap-4 mb-6">
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Catalogue total</div>
                    <div className="text-2xl font-bold">{(data.reduce((s,m)=>s+m.inventory,0)/1000).toFixed(0)}K</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Trustpilot moy.</div>
                    <div className="text-2xl font-bold text-yellow-400">{(data.reduce((s,m)=>s+m.trustpilot,0)/data.length).toFixed(1)}â˜…</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Avec Premium</div>
                    <div className="text-2xl font-bold">{data.filter(m => m.premiumProgram).length}/{data.length}</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Affiliation moy.</div>
                    <div className="text-2xl font-bold text-green-400">{(data.reduce((s,m)=>s+parseFloat(m.affiliateRate),0)/data.length).toFixed(1)}%</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Menaces hautes</div>
                    <div className="text-2xl font-bold text-red-400">{data.filter(m=>m.threat==='high').length}</div>
                </div>
            </div>

            <div className="glass rounded-xl border border-dark-600 overflow-hidden">
                <table className="w-full">
                    <thead className="bg-dark-700">
                        <tr>
                            <th className="text-left px-4 py-3 text-sm font-semibold">Marchand</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold cursor-pointer hover:text-accent-blue" onClick={() => handleSort('trustpilot')}>Trustpilot<SortIcon field="trustpilot" /></th>
                            <th className="text-center px-4 py-3 text-sm font-semibold cursor-pointer hover:text-accent-blue" onClick={() => handleSort('reliability')}>FiabilitÃ© TPA<SortIcon field="reliability" /></th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Premium</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold cursor-pointer hover:text-accent-blue" onClick={() => handleSort('inventory')}>Catalogue<SortIcon field="inventory" /></th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Affiliation</th>
                            <th className="text-left px-4 py-3 text-sm font-semibold">Promo active</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-dark-600">
                        {sortedMerchants.map(m => (
                            <tr key={m.id} className="hover:bg-dark-700/50 group">
                                <td className="px-4 py-3">
                                    <div className="flex items-center space-x-3">
                                        <span className="text-xl">{m.logo}</span>
                                        <div>
                                            <div className="font-medium">{m.name}</div>
                                            <div className="text-xs text-gray-500">{m.domain} â€¢ depuis {m.foundedYear}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`font-semibold ${m.trustpilot >= 4.5 ? 'text-green-400' : m.trustpilot >= 4 ? 'text-yellow-400' : 'text-red-400'}`}>
                                        {m.trustpilot}â˜…
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`font-bold ${m.reliability >= 80 ? 'text-green-400' : m.reliability >= 60 ? 'text-yellow-400' : 'text-red-400'}`}>
                                        {m.reliability}%
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    {m.premiumProgram ? (
                                        <span className="text-purple-400 font-medium">{m.premiumProgram}</span>
                                    ) : (
                                        <span className="text-gray-500">â€”</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-right text-gray-400 font-mono">{m.inventory.toLocaleString()}</td>
                                <td className="px-4 py-3 text-center">
                                    <span className="text-green-400 font-semibold">{m.affiliateRate}</span>
                                </td>
                                <td className="px-4 py-3">
                                    <span className="text-sm text-yellow-400"><i className="fas fa-tag mr-1"></i>{m.lastPromo}</span>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <div className="flex items-center justify-center space-x-2">
                                        <span className={`px-2 py-1 rounded text-xs ${
                                            m.threat === 'high' ? 'bg-red-500/20 text-red-400' :
                                            m.threat === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                                            'bg-green-500/20 text-green-400'
                                        }`}>{m.threat === 'high' ? 'ðŸ”´' : m.threat === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢'}</span>
                                        <button onClick={() => openEdit(m)} className="opacity-0 group-hover:opacity-100 p-1.5 bg-dark-600 rounded hover:bg-dark-500 transition">
                                            <i className="fas fa-edit text-xs text-gray-400"></i>
                                        </button>
                                        <button onClick={() => handleDelete(m.id)} className="opacity-0 group-hover:opacity-100 p-1.5 bg-dark-600 rounded hover:bg-red-500/20 transition">
                                            <i className="fas fa-trash text-xs text-red-400"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Legend */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>MÃ©triques</h3>
                <div className="grid grid-cols-3 gap-4 text-sm text-gray-400">
                    <div><strong>Trustpilot</strong> : Note publique utilisateurs</div>
                    <div><strong>FiabilitÃ© TPA</strong> : <span className="text-xs text-blue-400 cursor-help" title="True Price Authority - Score basÃ© sur nos relevÃ©s de prix comparant prix affichÃ©s vs prix checkout">Score basÃ© sur nos relevÃ©s</span></div>
                    <div><strong>Premium</strong> : Programme fidÃ©litÃ© payant (prix/mois)</div>
                    <div><strong>Catalogue</strong> : Nombre de produits actifs</div>
                    <div><strong>Affiliation</strong> : Commission affiliÃ© standard</div>
                    <div><strong>Menace</strong> : Niveau de concurrence</div>
                </div>
            </div>

            {/* Edit/Add Modal */}
            <EditModal
                isOpen={editingItem !== null || isAdding}
                onClose={() => { setEditingItem(null); setIsAdding(false); }}
                title={isAdding ? 'Ajouter un marchand' : 'Modifier le marchand'}
                onSave={handleSave}
            >
                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Nom</label>
                            <input type="text" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Logo (emoji)</label>
                            <input type="text" value={formData.logo || ''} onChange={e => setFormData({...formData, logo: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Domaine</label>
                        <input type="text" value={formData.domain || ''} onChange={e => setFormData({...formData, domain: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" placeholder="example.com" />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">FiabilitÃ© TPA (%)</label>
                            <input type="number" min="0" max="100" value={formData.reliability || 50} onChange={e => setFormData({...formData, reliability: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Trustpilot</label>
                            <input type="number" step="0.1" min="0" max="5" value={formData.trustpilot || 4.0} onChange={e => setFormData({...formData, trustpilot: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Catalogue</label>
                            <input type="number" value={formData.inventory || 1000} onChange={e => setFormData({...formData, inventory: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Affiliation</label>
                            <input type="text" value={formData.affiliateRate || '5%'} onChange={e => setFormData({...formData, affiliateRate: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Programme Premium</label>
                            <input type="text" value={formData.premiumProgram || ''} onChange={e => setFormData({...formData, premiumProgram: e.target.value || null})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" placeholder="null ou prix/mois" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Promo active</label>
                        <input type="text" value={formData.lastPromo || ''} onChange={e => setFormData({...formData, lastPromo: e.target.value})}
                            className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">AnnÃ©e de crÃ©ation</label>
                            <input type="number" value={formData.foundedYear || 2020} onChange={e => setFormData({...formData, foundedYear: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-1">Niveau de menace</label>
                            <select value={formData.threat || 'medium'} onChange={e => setFormData({...formData, threat: e.target.value})}
                                className="w-full px-3 py-2 bg-dark-700 border border-dark-600 rounded-lg focus:border-accent-blue outline-none">
                                <option value="low">Faible</option>
                                <option value="medium">Moyenne</option>
                                <option value="high">Haute</option>
                            </select>
                        </div>
                    </div>
                </div>
            </EditModal>
        </div>
    );
}

function SitemapChecker({ comparatorsData = comparators }) {
    const [scanning, setScanning] = useState(false);
    const [scanProgress, setScanProgress] = useState({ current: 0, total: 0, site: '' });
    const [sitemapData, setSitemapData] = useState(() => {
        // Charger depuis localStorage si disponible
        const saved = localStorage.getItem('ci_sitemap_data');
        if (saved) {
            try { return JSON.parse(saved); } catch(e) { return {}; }
        }
        return {};
    });

    // Scanner un site via notre API Vercel
    const scanSite = async (sitemapUrl) => {
        try {
            const response = await fetch('/api/sitemap-check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: sitemapUrl, maxSubsitemaps: 30 })
            });
            const data = await response.json();

            if (data.success) {
                return {
                    count: data.count,
                    subsitemaps: data.subsitemapsTotal || null,
                    extrapolated: data.extrapolated || false,
                    error: null
                };
            } else {
                return { count: 0, error: data.error || 'Erreur API' };
            }
        } catch (error) {
            return { count: 0, error: error.message || 'Erreur rÃ©seau' };
        }
    };

    // Scanner tous les comparateurs
    const runFullScan = async () => {
        setScanning(true);
        setScanProgress({ current: 0, total: comparatorsData.length, site: '' });

        const now = new Date().toLocaleString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const newData = { ...sitemapData };

        for (let i = 0; i < comparatorsData.length; i++) {
            const comp = comparatorsData[i];
            setScanProgress({ current: i + 1, total: comparatorsData.length, site: comp.name });

            const result = await scanSite(comp.sitemapUrl);

            // Calculer la diffÃ©rence avec le scan prÃ©cÃ©dent
            const previousCount = newData[comp.name]?.count || 0;
            const diff = result.count - previousCount;

            newData[comp.name] = {
                count: result.count,
                previousCount: previousCount,
                diff: diff,
                lastCheck: now,
                error: result.error,
                subsitemaps: result.subsitemaps || null
            };

            setSitemapData({...newData});
        }

        // Sauvegarder dans localStorage
        localStorage.setItem('ci_sitemap_data', JSON.stringify(newData));
        setScanning(false);
    };

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Sitemap Checker</h1>
                    <p className="text-gray-500">Surveillance des sitemaps concurrents (donnÃ©es rÃ©elles)</p>
                </div>
                <button
                    onClick={runFullScan}
                    disabled={scanning}
                    className={`px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 ${
                        scanning ? 'bg-gray-600 cursor-not-allowed' : 'bg-accent-green hover:bg-green-600'
                    }`}
                >
                    {scanning ? (
                        <><i className="fas fa-spinner fa-spin"></i><span>Scan {scanProgress.current}/{scanProgress.total} ({scanProgress.site})</span></>
                    ) : (
                        <><i className="fas fa-satellite-dish"></i><span>Scanner les sitemaps</span></>
                    )}
                </button>
            </div>

            <div className="glass rounded-xl border border-dark-600 overflow-hidden mb-6">
                <table className="w-full">
                    <thead className="bg-dark-700">
                        <tr>
                            <th className="text-left px-4 py-3 text-sm font-semibold">Site</th>
                            <th className="text-left px-4 py-3 text-sm font-semibold">URL Sitemap</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold">Pages</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold">Diff</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Status</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold">Dernier check</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-dark-600">
                        {comparatorsData.map(c => {
                            const data = sitemapData[c.name];
                            const hasData = data && data.count > 0;
                            const hasError = data && data.error;

                            return (
                                <tr key={c.id} className="hover:bg-dark-700/50">
                                    <td className="px-4 py-3">
                                        <div className="flex items-center space-x-2">
                                            <span className="text-xl">{c.logo}</span>
                                            <div>
                                                <span className="font-medium">{c.name}</span>
                                                {data?.subsitemaps && <span className="text-xs text-gray-500 ml-2">({data.subsitemaps} sous-sitemaps)</span>}
                                            </div>
                                        </div>
                                    </td>
                                    <td className="px-4 py-3">
                                        <a href={c.sitemapUrl} target="_blank" className="text-accent-blue hover:underline text-sm truncate block max-w-xs">{c.sitemapUrl}</a>
                                    </td>
                                    <td className="px-4 py-3 text-right font-mono">
                                        {hasData ? data.count.toLocaleString() : <span className="text-gray-500">-</span>}
                                    </td>
                                    <td className="px-4 py-3 text-right">
                                        {hasData && data.diff !== 0 ? (
                                            <span className={`font-semibold ${data.diff > 0 ? (data.diff > 1000 ? 'text-red-400' : data.diff > 100 ? 'text-yellow-400' : 'text-green-400') : 'text-blue-400'}`}>
                                                {data.diff > 0 ? '+' : ''}{data.diff.toLocaleString()}
                                            </span>
                                        ) : hasData ? (
                                            <span className="text-gray-500">0</span>
                                        ) : (
                                            <span className="text-gray-500">-</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                        {hasError ? (
                                            <span className="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded" title={data.error}>Erreur</span>
                                        ) : hasData ? (
                                            <span className="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">OK</span>
                                        ) : (
                                            <span className="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">En attente</span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-right text-sm text-gray-400">
                                        {data?.lastCheck || '-'}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            <div className="glass rounded-xl border border-dark-600 p-4">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>Comment Ã§a marche</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong className="text-green-400">DonnÃ©es rÃ©elles</strong> : Les sitemaps sont fetchÃ©s et parsÃ©s en temps rÃ©el</li>
                    <li>â€¢ <strong>Diff</strong> : Compare avec le dernier scan (stockÃ© en localStorage)</li>
                    <li>â€¢ <strong>Sitemap index</strong> : Si le sitemap contient des sous-sitemaps, on en scanne jusqu'Ã  50 et extrapole</li>
                    <li>â€¢ <strong>Proxy CORS</strong> : Utilise api.allorigins.win pour contourner les restrictions navigateur</li>
                </ul>
            </div>
        </div>
    );
}

function PriceChecker({ selectedGame, setSelectedGame }) {
    const [offers, setOffers] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Config Supabase (partagÃ©e avec PriceTracker)
    const supabaseConfig = {
        url: 'https://ngzvurmhqnanoghjyswh.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nenZ1cm1ocW5hbm9naGp5c3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTc2MTIsImV4cCI6MjA4NDE3MzYxMn0.Sk9M-tUkZY5p0OPw7xT0UOaIgOR3SQRACSVyi_TL61Q'
    };

    // DonnÃ©es dÃ©mo pour Price Checker
    const demoOffers = [
        { id: 'demo-1', name: 'GTA VI', source: 'CDKeys', displayed_price: 54.99 },
        { id: 'demo-2', name: 'GTA VI', source: 'Instant Gaming', displayed_price: 52.99 },
        { id: 'demo-3', name: 'GTA VI', source: 'G2A', displayed_price: 49.99 },
        { id: 'demo-4', name: 'EA FC 25', source: 'Eneba', displayed_price: 44.99 },
        { id: 'demo-5', name: 'EA FC 25', source: 'Kinguin', displayed_price: 42.50 },
        { id: 'demo-6', name: 'Elden Ring', source: 'Fanatical', displayed_price: 34.99 },
    ];
    const demoChecks = [
        { id: 'dc-1', offer_id: 'demo-1', checkout_price: 54.99, check_date: '2026-01-30' },
        { id: 'dc-2', offer_id: 'demo-2', checkout_price: 55.49, check_date: '2026-01-30' },
        { id: 'dc-3', offer_id: 'demo-3', checkout_price: 56.99, check_date: '2026-01-30' },
        { id: 'dc-4', offer_id: 'demo-4', checkout_price: 44.99, check_date: '2026-01-29' },
        { id: 'dc-5', offer_id: 'demo-5', checkout_price: 47.80, check_date: '2026-01-29' },
        { id: 'dc-6', offer_id: 'demo-6', checkout_price: 34.99, check_date: '2026-01-28' },
    ];

    // Charger les donnÃ©es depuis Supabase ou mode dÃ©mo
    const loadData = async () => {
        setLoading(true);
        setError(null);

        // Mode dÃ©mo : utiliser donnÃ©es de test
        if (isDemoMode()) {
            const offersWithHistory = demoOffers.map(offer => ({
                ...offer,
                history: demoChecks.filter(c => c.offer_id === offer.id),
                lastCheck: demoChecks.find(c => c.offer_id === offer.id)
            }));
            setOffers(offersWithHistory);
            if (!selectedGame) setSelectedGame('GTA VI');
            setLoading(false);
            return;
        }

        try {
            const [offersRes, checksRes] = await Promise.all([
                fetch(`${supabaseConfig.url}/rest/v1/offers?select=*&order=created_at.desc`, {
                    headers: { 'apikey': supabaseConfig.key, 'Authorization': `Bearer ${supabaseConfig.key}` }
                }),
                fetch(`${supabaseConfig.url}/rest/v1/price_checks?select=*&order=check_date.desc`, {
                    headers: { 'apikey': supabaseConfig.key, 'Authorization': `Bearer ${supabaseConfig.key}` }
                })
            ]);
            if (!offersRes.ok || !checksRes.ok) throw new Error('Erreur chargement');
            const [offersData, checksData] = await Promise.all([offersRes.json(), checksRes.json()]);

            // Associer les checks aux offers (conversion en Number pour Ã©viter mismatch string/number)
            const offersWithHistory = offersData.map(offer => ({
                ...offer,
                history: checksData.filter(c => Number(c.offer_id) === Number(offer.id)),
                lastCheck: checksData.find(c => Number(c.offer_id) === Number(offer.id))
            }));
            setOffers(offersWithHistory);

            // SÃ©lectionner le premier jeu si aucun sÃ©lectionnÃ©
            if (!selectedGame && offersWithHistory.length > 0) {
                const games = [...new Set(offersWithHistory.map(o => o.name).filter(Boolean))];
                if (games.length > 0) setSelectedGame(games[0]);
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { loadData(); }, []);

    // Extraire les jeux uniques
    const games = [...new Set(offers.map(o => o.name).filter(Boolean))];

    // Filtrer les offres pour le jeu sÃ©lectionnÃ©
    const gameOffers = offers.filter(o => o.name === selectedGame);

    // Calculer les stats de prÃ©cision par source (comparateur/marchand)
    const calculatePrecision = (offer) => {
        // Prix affichÃ©: depuis l'offre OU depuis le dernier relevÃ© (reference_price)
        const displayedPrice = offer.displayed_price || offer.lastCheck?.reference_price;
        // Prix checkout: prix PayPal ou Carte depuis price_checks (checkout_price pour dÃ©mo)
        const checkoutPrice = offer.lastCheck?.price_paypal || offer.lastCheck?.price_card || offer.lastCheck?.checkout_price;

        if (!displayedPrice || !checkoutPrice) return null;
        const diff = checkoutPrice - displayedPrice;
        const pct = (diff / displayedPrice * 100);
        return { diff, pct, isAccurate: Math.abs(pct) < 2 };
    };

    // Trier par Ã©cart (les plus prÃ©cis d'abord)
    const sortedOffers = [...gameOffers].sort((a, b) => {
        const precA = calculatePrecision(a);
        const precB = calculatePrecision(b);
        if (!precA && !precB) return 0;
        if (!precA) return 1;
        if (!precB) return -1;
        return Math.abs(precA.pct) - Math.abs(precB.pct);
    });

    // Stats globales
    const offersWithPrecision = sortedOffers.filter(o => calculatePrecision(o));
    const avgPrecision = offersWithPrecision.length > 0
        ? offersWithPrecision.reduce((sum, o) => sum + Math.abs(calculatePrecision(o).pct), 0) / offersWithPrecision.length
        : 0;
    const accurateCount = offersWithPrecision.filter(o => calculatePrecision(o).isAccurate).length;

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Price Checker</h1>
                    <p className="text-gray-500">PrÃ©cision des prix comparateurs vs prix rÃ©els marchands</p>
                </div>
                <button
                    onClick={loadData}
                    disabled={loading}
                    className={`px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 ${
                        loading ? 'bg-gray-600 cursor-not-allowed' : 'bg-accent-green hover:bg-green-600'
                    }`}
                >
                    {loading ? <><i className="fas fa-spinner fa-spin"></i><span>Chargement...</span></> : <><i className="fas fa-sync-alt"></i><span>Actualiser</span></>}
                </button>
            </div>

            {error && (
                <div className="glass rounded-xl border border-red-500/50 p-4 mb-6 bg-red-500/10">
                    <p className="text-red-400"><i className="fas fa-exclamation-triangle mr-2"></i>{error}</p>
                </div>
            )}

            {games.length > 0 ? (
                <>
                    <div className="glass rounded-xl border border-dark-600 p-4 mb-6">
                        <label className="block text-sm text-gray-400 mb-3">SÃ©lectionner un jeu ({games.length} disponibles)</label>
                        <div className="flex flex-wrap gap-2">
                            {games.map(game => (
                                <button
                                    key={game}
                                    onClick={() => setSelectedGame(game)}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                                        selectedGame === game ? 'bg-accent-blue text-white' : 'bg-dark-700 hover:bg-dark-600 text-gray-300'
                                    }`}
                                >
                                    {game}
                                </button>
                            ))}
                        </div>
                    </div>

                    {selectedGame && sortedOffers.length > 0 && (
                        <>
                            {/* Stats */}
                            <div className="grid grid-cols-4 gap-4 mb-6">
                                <div className="glass rounded-xl border border-dark-600 p-4">
                                    <div className="text-sm text-gray-500 mb-1">Offres suivies</div>
                                    <div className="text-2xl font-bold">{sortedOffers.length}</div>
                                </div>
                                <div className="glass rounded-xl border border-dark-600 p-4">
                                    <div className="text-sm text-gray-500 mb-1">Avec relevÃ© prix</div>
                                    <div className="text-2xl font-bold">{offersWithPrecision.length}</div>
                                </div>
                                <div className="glass rounded-xl border border-green-500/30 p-4 bg-green-500/5">
                                    <div className="text-sm text-green-400 mb-1">Prix prÃ©cis (&lt;2%)</div>
                                    <div className="text-2xl font-bold text-green-400">{accurateCount}</div>
                                </div>
                                <div className="glass rounded-xl border border-yellow-500/30 p-4 bg-yellow-500/5">
                                    <div className="text-sm text-yellow-400 mb-1">Ã‰cart moyen</div>
                                    <div className="text-2xl font-bold text-yellow-400">{avgPrecision.toFixed(1)}%</div>
                                </div>
                            </div>

                            {/* Table */}
                            <div className="glass rounded-xl border border-dark-600 overflow-hidden">
                                <div className="p-4 border-b border-dark-600">
                                    <h2 className="text-xl font-bold">{selectedGame}</h2>
                                    <p className="text-sm text-gray-500">Comparaison prix affichÃ© (comparateur) vs prix rÃ©el (checkout marchand)</p>
                                </div>
                                <table className="w-full">
                                    <thead className="bg-dark-700">
                                        <tr>
                                            <th className="text-left px-4 py-3 text-sm font-semibold">Source / Marchand</th>
                                            <th className="text-right px-4 py-3 text-sm font-semibold">Prix affichÃ©</th>
                                            <th className="text-right px-4 py-3 text-sm font-semibold">Prix checkout</th>
                                            <th className="text-center px-4 py-3 text-sm font-semibold">Ã‰cart</th>
                                            <th className="text-center px-4 py-3 text-sm font-semibold">PrÃ©cision</th>
                                            <th className="text-center px-4 py-3 text-sm font-semibold">Preuve</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-dark-600">
                                        {sortedOffers.map((offer, i) => {
                                            const precision = calculatePrecision(offer);
                                            return (
                                                <tr key={offer.id} className={`hover:bg-dark-700/50 ${precision?.isAccurate ? 'bg-green-500/5' : precision && Math.abs(precision.pct) > 10 ? 'bg-red-500/5' : ''}`}>
                                                    <td className="px-4 py-3">
                                                        <div className="font-medium">{offer.store || 'Inconnu'}</div>
                                                        <a href={offer.url} target="_blank" className="text-xs text-accent-blue hover:underline truncate block max-w-xs">{offer.url}</a>
                                                    </td>
                                                    <td className="px-4 py-3 text-right font-mono">
                                                        {(offer.displayed_price || offer.lastCheck?.reference_price) ? `${(offer.displayed_price || offer.lastCheck?.reference_price).toFixed(2)}â‚¬` : '-'}
                                                    </td>
                                                    <td className="px-4 py-3 text-right font-mono">
                                                        {(offer.lastCheck?.price_paypal || offer.lastCheck?.price_card || offer.lastCheck?.checkout_price) ? `${(offer.lastCheck?.price_paypal || offer.lastCheck?.price_card || offer.lastCheck?.checkout_price).toFixed(2)}â‚¬` : '-'}
                                                    </td>
                                                    <td className="px-4 py-3 text-center">
                                                        {precision ? (
                                                            <span className={`font-semibold ${precision.diff > 0 ? 'text-red-400' : precision.diff < 0 ? 'text-green-400' : 'text-gray-400'}`}>
                                                                {precision.diff > 0 ? '+' : ''}{precision.diff.toFixed(2)}â‚¬
                                                            </span>
                                                        ) : '-'}
                                                    </td>
                                                    <td className="px-4 py-3 text-center">
                                                        {precision ? (
                                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                                                precision.isAccurate ? 'bg-green-500/20 text-green-400' :
                                                                Math.abs(precision.pct) > 10 ? 'bg-red-500/20 text-red-400' :
                                                                'bg-yellow-500/20 text-yellow-400'
                                                            }`}>
                                                                {precision.pct > 0 ? '+' : ''}{precision.pct.toFixed(1)}%
                                                            </span>
                                                        ) : <span className="text-gray-500">-</span>}
                                                    </td>
                                                    <td className="px-4 py-3 text-center">
                                                        {offer.lastCheck?.screenshot_url ? (
                                                            <a href={offer.lastCheck.screenshot_url} target="_blank" className="text-accent-blue hover:underline">
                                                                <i className="fas fa-image"></i>
                                                            </a>
                                                        ) : offer.displayed_price_screenshot ? (
                                                            <a href={offer.displayed_price_screenshot} target="_blank" className="text-accent-blue hover:underline">
                                                                <i className="fas fa-image"></i>
                                                            </a>
                                                        ) : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </>
                    )}
                </>
            ) : !loading && (
                <div className="glass rounded-xl border border-dark-600 p-8 text-center">
                    <i className="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
                    <p className="text-gray-500">Aucune donnÃ©e de prix</p>
                    <p className="text-sm text-gray-600 mt-2">Utilisez l'extension Chrome pour capturer des relevÃ©s de prix</p>
                </div>
            )}

            {/* LÃ©gende */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>Comprendre les donnÃ©es</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong>Prix affichÃ©</strong> : Prix vu sur le comparateur (AllKeyShop, GG.deals...)</li>
                    <li>â€¢ <strong>Prix checkout</strong> : Prix rÃ©el au moment de payer chez le marchand</li>
                    <li>â€¢ <strong className="text-green-400">PrÃ©cis (&lt;2%)</strong> : Le comparateur affiche le bon prix</li>
                    <li>â€¢ <strong className="text-yellow-400">Ã‰cart modÃ©rÃ© (2-10%)</strong> : LÃ©gÃ¨re diffÃ©rence</li>
                    <li>â€¢ <strong className="text-red-400">Trompeur (&gt;10%)</strong> : Prix affichÃ© trÃ¨s diffÃ©rent du rÃ©el</li>
                </ul>
            </div>
        </div>
    );
}

function StatusChecker() {
    const [scanning, setScanning] = useState(false);
    const [scanProgress, setScanProgress] = useState({ current: 0, total: 0 });
    const [expandedSites, setExpandedSites] = useState(Object.keys(serviceStatus));
    const [statusData, setStatusData] = useState(serviceStatus);

    const toggleSite = (site) => {
        if (expandedSites.includes(site)) {
            setExpandedSites(expandedSites.filter(s => s !== site));
        } else {
            setExpandedSites([...expandedSites, site]);
        }
    };

    // VÃ©rifier une URL via notre API Vercel
    const checkUrl = async (url) => {
        try {
            const response = await fetch('/api/status-check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await response.json();

            return {
                status: data.status || 'error',
                responseTime: data.responseTime || 0,
                error: data.error || null
            };
        } catch (error) {
            return {
                status: 'error',
                responseTime: 0,
                error: error.message || 'Erreur rÃ©seau'
            };
        }
    };

    // Scanner toutes les URLs
    const runFullScan = async () => {
        setScanning(true);
        const newStatusData = JSON.parse(JSON.stringify(statusData));

        // Compter le total d'URLs Ã  scanner
        let totalUrls = 0;
        Object.values(newStatusData).forEach(site => {
            totalUrls += site.services.length + site.merchantVouchers.length;
        });
        setScanProgress({ current: 0, total: totalUrls });

        let currentCount = 0;
        const now = new Date().toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });

        // Scanner chaque site
        for (const [siteName, siteData] of Object.entries(newStatusData)) {
            // Scanner les services principaux
            for (let i = 0; i < siteData.services.length; i++) {
                const result = await checkUrl(siteData.services[i].url);
                newStatusData[siteName].services[i] = {
                    ...siteData.services[i],
                    status: result.status,
                    responseTime: result.responseTime,
                    error: result.error,
                    lastCheck: now
                };
                currentCount++;
                setScanProgress({ current: currentCount, total: totalUrls });
                setStatusData({...newStatusData});
            }

            // Scanner les pages vouchers marchands
            for (let i = 0; i < siteData.merchantVouchers.length; i++) {
                const result = await checkUrl(siteData.merchantVouchers[i].url);
                newStatusData[siteName].merchantVouchers[i] = {
                    ...siteData.merchantVouchers[i],
                    status: result.status,
                    responseTime: result.responseTime,
                    error: result.error,
                    lastCheck: now
                };
                currentCount++;
                setScanProgress({ current: currentCount, total: totalUrls });
                setStatusData({...newStatusData});
            }
        }

        setScanning(false);
    };

    const getStatusIcon = (status) => {
        switch(status) {
            case 'online': return <span className="text-green-400"><i className="fas fa-check-circle"></i></span>;
            case 'offline': return <span className="text-red-400"><i className="fas fa-times-circle"></i></span>;
            case 'warning': return <span className="text-yellow-400"><i className="fas fa-exclamation-triangle"></i></span>;
            case 'pending': return <span className="text-blue-400"><i className="fas fa-clock"></i></span>;
            case 'error': return <span className="text-red-400"><i className="fas fa-exclamation-circle"></i></span>;
            default: return <span className="text-gray-400"><i className="fas fa-question-circle"></i></span>;
        }
    };

    const getStatusBg = (status) => {
        switch(status) {
            case 'online': return 'bg-green-500/10 border-green-500/30';
            case 'offline': return 'bg-red-500/10 border-red-500/30';
            case 'warning': return 'bg-yellow-500/10 border-yellow-500/30';
            case 'pending': return 'bg-blue-500/10 border-blue-500/30';
            case 'error': return 'bg-red-500/10 border-red-500/30';
            default: return 'bg-gray-500/10 border-gray-500/30';
        }
    };

    const totalServices = Object.values(statusData).reduce((acc, site) => acc + site.services.length + site.merchantVouchers.length, 0);
    const onlineCount = Object.values(statusData).reduce((acc, site) => {
        return acc + site.services.filter(s => s.status === 'online').length + site.merchantVouchers.filter(m => m.status === 'online').length;
    }, 0);
    const offlineCount = Object.values(statusData).reduce((acc, site) => {
        return acc + site.services.filter(s => s.status === 'offline').length + site.merchantVouchers.filter(m => m.status === 'offline').length;
    }, 0);
    const warningCount = Object.values(statusData).reduce((acc, site) => {
        return acc + site.services.filter(s => s.status === 'warning').length + site.merchantVouchers.filter(m => m.status === 'warning').length;
    }, 0);
    const pendingCount = Object.values(statusData).reduce((acc, site) => {
        return acc + site.services.filter(s => s.status === 'pending').length + site.merchantVouchers.filter(m => m.status === 'pending').length;
    }, 0);
    const errorCount = Object.values(statusData).reduce((acc, site) => {
        return acc + site.services.filter(s => s.status === 'error').length + site.merchantVouchers.filter(m => m.status === 'error').length;
    }, 0);

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Status Checker</h1>
                    <p className="text-gray-500">Monitoring santÃ© des services concurrents</p>
                </div>
                <button
                    onClick={runFullScan}
                    disabled={scanning}
                    className={`px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 ${
                        scanning ? 'bg-gray-600 cursor-not-allowed' : 'bg-accent-green hover:bg-green-600'
                    }`}
                >
                    {scanning ? (
                        <><i className="fas fa-spinner fa-spin"></i><span>Scan {scanProgress.current}/{scanProgress.total}</span></>
                    ) : (
                        <><i className="fas fa-satellite-dish"></i><span>Scanner tout</span></>
                    )}
                </button>
            </div>

            {/* Stats globales */}
            <div className="grid grid-cols-6 gap-4 mb-6">
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Total services</div>
                    <div className="text-2xl font-bold">{totalServices}</div>
                </div>
                <div className="glass rounded-xl border border-green-500/30 p-4 bg-green-500/5">
                    <div className="text-sm text-green-400 mb-1"><i className="fas fa-check-circle mr-1"></i>En ligne</div>
                    <div className="text-2xl font-bold text-green-400">{onlineCount}</div>
                </div>
                <div className="glass rounded-xl border border-blue-500/30 p-4 bg-blue-500/5">
                    <div className="text-sm text-blue-400 mb-1"><i className="fas fa-clock mr-1"></i>En attente</div>
                    <div className="text-2xl font-bold text-blue-400">{pendingCount}</div>
                </div>
                <div className="glass rounded-xl border border-yellow-500/30 p-4 bg-yellow-500/5">
                    <div className="text-sm text-yellow-400 mb-1"><i className="fas fa-exclamation-triangle mr-1"></i>Warnings</div>
                    <div className="text-2xl font-bold text-yellow-400">{warningCount}</div>
                </div>
                <div className="glass rounded-xl border border-red-500/30 p-4 bg-red-500/5">
                    <div className="text-sm text-red-400 mb-1"><i className="fas fa-times-circle mr-1"></i>Hors ligne</div>
                    <div className="text-2xl font-bold text-red-400">{offlineCount}</div>
                </div>
                <div className="glass rounded-xl border border-red-500/30 p-4 bg-red-500/5">
                    <div className="text-sm text-red-400 mb-1"><i className="fas fa-exclamation-circle mr-1"></i>Erreurs</div>
                    <div className="text-2xl font-bold text-red-400">{errorCount}</div>
                </div>
            </div>

            {/* Tree structure par site */}
            <div className="space-y-4">
                {Object.entries(statusData).map(([siteName, siteData]) => {
                    const isExpanded = expandedSites.includes(siteName);
                    const siteOffline = siteData.services.filter(s => s.status === 'offline').length + siteData.merchantVouchers.filter(m => m.status === 'offline').length;
                    const siteWarning = siteData.services.filter(s => s.status === 'warning').length + siteData.merchantVouchers.filter(m => m.status === 'warning').length;
                    const siteOnline = siteData.services.filter(s => s.status === 'online').length + siteData.merchantVouchers.filter(m => m.status === 'online').length;
                    const sitePending = siteData.services.filter(s => s.status === 'pending').length + siteData.merchantVouchers.filter(m => m.status === 'pending').length;
                    const siteError = siteData.services.filter(s => s.status === 'error').length + siteData.merchantVouchers.filter(m => m.status === 'error').length;
                    const totalSiteServices = siteData.services.length + siteData.merchantVouchers.length;

                    return (
                        <div key={siteName} className="glass rounded-xl border border-dark-600 overflow-hidden">
                            {/* Site header */}
                            <div
                                className="p-4 flex items-center justify-between cursor-pointer hover:bg-dark-700/50 transition"
                                onClick={() => toggleSite(siteName)}
                            >
                                <div className="flex items-center space-x-3">
                                    <span className="text-2xl">{siteData.logo}</span>
                                    <div>
                                        <div className="font-bold text-lg">{siteName}</div>
                                        <div className="text-sm text-gray-500">{siteData.domain}</div>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="flex items-center space-x-2 text-sm">
                                        {siteOnline > 0 && <span className="px-2 py-1 rounded bg-green-500/20 text-green-400">{siteOnline} <i className="fas fa-check"></i></span>}
                                        {sitePending > 0 && <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-400">{sitePending} <i className="fas fa-clock"></i></span>}
                                        {siteWarning > 0 && <span className="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400">{siteWarning} <i className="fas fa-exclamation"></i></span>}
                                        {siteOffline > 0 && <span className="px-2 py-1 rounded bg-red-500/20 text-red-400">{siteOffline} <i className="fas fa-times"></i></span>}
                                        {siteError > 0 && <span className="px-2 py-1 rounded bg-red-500/20 text-red-400">{siteError} <i className="fas fa-exclamation-circle"></i></span>}
                                    </div>
                                    <i className={`fas fa-chevron-${isExpanded ? 'up' : 'down'} text-gray-500`}></i>
                                </div>
                            </div>

                            {/* Expanded tree */}
                            {isExpanded && (
                                <div className="border-t border-dark-600 p-4 pl-6 space-y-2">
                                    {/* Main services */}
                                    <div className="mb-3">
                                        <div className="text-xs text-gray-500 uppercase font-semibold mb-2 flex items-center">
                                            <i className="fas fa-folder-open mr-2"></i>Services principaux
                                        </div>
                                        <div className="space-y-1 ml-4 border-l-2 border-dark-600 pl-4">
                                            {siteData.services.map((service, idx) => (
                                                <div key={idx} className={`p-2 rounded border ${getStatusBg(service.status)} flex items-center justify-between`}>
                                                    <div className="flex items-center space-x-3">
                                                        {getStatusIcon(service.status)}
                                                        <div>
                                                            <div className="font-medium text-sm">{service.name}</div>
                                                            <a href={service.url} target="_blank" className="text-xs text-accent-blue hover:underline truncate block max-w-md">{service.url}</a>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        {service.responseTime && <div className="text-xs text-gray-400">{service.responseTime}ms</div>}
                                                        {service.error && <div className="text-xs text-red-400">{service.error}</div>}
                                                        <div className="text-xs text-gray-500">{service.lastCheck}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Merchant vouchers */}
                                    {siteData.merchantVouchers.length > 0 && (
                                        <div>
                                            <div className="text-xs text-gray-500 uppercase font-semibold mb-2 flex items-center">
                                                <i className="fas fa-ticket-alt mr-2"></i>Pages Vouchers par marchand
                                            </div>
                                            <div className="space-y-1 ml-4 border-l-2 border-dark-600 pl-4">
                                                {siteData.merchantVouchers.map((voucher, idx) => (
                                                    <div key={idx} className={`p-2 rounded border ${getStatusBg(voucher.status)} flex items-center justify-between`}>
                                                        <div className="flex items-center space-x-3">
                                                            {getStatusIcon(voucher.status)}
                                                            <div>
                                                                <div className="font-medium text-sm">{voucher.merchant}</div>
                                                                <a href={voucher.url} target="_blank" className="text-xs text-accent-blue hover:underline truncate block max-w-md">{voucher.url}</a>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            {voucher.error && <div className="text-xs text-red-400">{voucher.error}</div>}
                                                            <div className="text-xs text-gray-500">{voucher.lastCheck}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>

            {/* Info box */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>DÃ©tection automatique</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong className="text-green-400">Online</strong> : Page accessible et contenu valide</li>
                    <li>â€¢ <strong className="text-blue-400">En attente</strong> : URL non encore vÃ©rifiÃ©e (cliquez sur Scanner)</li>
                    <li>â€¢ <strong className="text-yellow-400">Warning</strong> : Page vide, rÃ©ponse lente (&gt;2s), ou contenu suspect</li>
                    <li>â€¢ <strong className="text-red-400">Offline (404)</strong> : La page n'existe pas ou plus</li>
                    <li>â€¢ <strong className="text-red-400">Error</strong> : Timeout, connexion refusÃ©e, ou erreur rÃ©seau</li>
                </ul>
                <p className="text-xs text-gray-500 mt-3">
                    <i className="fas fa-server mr-1"></i> Les requÃªtes passent par un proxy CORS (api.allorigins.win) pour contourner les restrictions navigateur.
                </p>
            </div>
        </div>
    );
}

// ===== PRICE TRACKER - Connexion Supabase =====
function PriceTrackerPage() {
    const [offers, setOffers] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [selectedOffer, setSelectedOffer] = useState(null);
    const [supabaseConfig, setSupabaseConfig] = useState(() => {
        const saved = localStorage.getItem('ci_supabase_config');
        if (saved) try { return JSON.parse(saved); } catch(e) {}
        return {
            url: 'https://ngzvurmhqnanoghjyswh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nenZ1cm1ocW5hbm9naGp5c3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTc2MTIsImV4cCI6MjA4NDE3MzYxMn0.Sk9M-tUkZY5p0OPw7xT0UOaIgOR3SQRACSVyi_TL61Q'
        };
    });
    const [configOpen, setConfigOpen] = useState(false);

    // DonnÃ©es dÃ©mo pour RelevÃ©s Prix
    const demoOffersTracker = [
        { id: 'demo-1', name: 'GTA VI', source: 'CDKeys', store: 'CDKeys', displayed_price: 54.99, url: 'https://cdkeys.com/gta6' },
        { id: 'demo-2', name: 'GTA VI', source: 'Instant Gaming', store: 'Instant Gaming', displayed_price: 52.99, url: 'https://instant-gaming.com/gta6' },
        { id: 'demo-3', name: 'GTA VI', source: 'G2A', store: 'G2A', displayed_price: 49.99, url: 'https://g2a.com/gta6' },
        { id: 'demo-4', name: 'EA FC 25', source: 'Eneba', store: 'Eneba', displayed_price: 44.99, url: 'https://eneba.com/eafc25' },
    ];
    const demoChecksTracker = [
        { id: 'dc-1', offer_id: 'demo-1', checkout_price: 54.99, check_date: '2026-01-30T12:00:00Z', notes: 'Prix exact' },
        { id: 'dc-2', offer_id: 'demo-2', checkout_price: 55.49, check_date: '2026-01-30T12:00:00Z', notes: 'Frais +2.50â‚¬' },
        { id: 'dc-3', offer_id: 'demo-3', checkout_price: 56.99, check_date: '2026-01-30T12:00:00Z', notes: 'Fees G2A +7â‚¬' },
        { id: 'dc-4', offer_id: 'demo-4', checkout_price: 44.99, check_date: '2026-01-29T12:00:00Z', notes: 'OK' },
    ];

    // Charger les offres depuis Supabase ou mode dÃ©mo
    const loadOffers = async () => {
        setLoading(true);
        setError(null);

        // Mode dÃ©mo
        if (isDemoMode()) {
            const offersWithHistory = demoOffersTracker.map(offer => ({
                ...offer,
                history: demoChecksTracker.filter(c => c.offer_id === offer.id)
            }));
            setOffers(offersWithHistory);
            setLoading(false);
            return;
        }

        if (!supabaseConfig.url || !supabaseConfig.key) {
            setError('Configuration Supabase manquante. Cliquez sur "Configurer" pour ajouter vos credentials.');
            setLoading(false);
            return;
        }

        try {
            // Fetch offers
            const offersRes = await fetch(`${supabaseConfig.url}/rest/v1/offers?select=*&order=created_at.desc`, {
                headers: {
                    'apikey': supabaseConfig.key,
                    'Authorization': `Bearer ${supabaseConfig.key}`
                }
            });
            if (!offersRes.ok) throw new Error(`Offers: HTTP ${offersRes.status}`);
            const offersData = await offersRes.json();

            // Fetch price checks
            const checksRes = await fetch(`${supabaseConfig.url}/rest/v1/price_checks?select=*&order=check_date.desc`, {
                headers: {
                    'apikey': supabaseConfig.key,
                    'Authorization': `Bearer ${supabaseConfig.key}`
                }
            });
            if (!checksRes.ok) throw new Error(`Checks: HTTP ${checksRes.status}`);
            const checksData = await checksRes.json();

            // Associer les checks aux offers
            const offersWithHistory = offersData.map(offer => ({
                ...offer,
                history: checksData.filter(c => c.offer_id === offer.id)
            }));

            setOffers(offersWithHistory);
        } catch (err) {
            setError(`Erreur: ${err.message}`);
        } finally {
            setLoading(false);
        }
    };

    // Sauvegarder la config
    const saveConfig = () => {
        localStorage.setItem('ci_supabase_config', JSON.stringify(supabaseConfig));
        setConfigOpen(false);
        loadOffers();
    };

    // Charger au mount si config prÃ©sente
    useEffect(() => {
        if (supabaseConfig.url && supabaseConfig.key) {
            loadOffers();
        }
    }, []);

    // Calculer l'Ã©cart prix affichÃ© vs prix rÃ©el
    const calcDiff = (offer) => {
        if (!offer.history || offer.history.length === 0) return null;
        const lastCheck = offer.history[0];
        if (!offer.displayed_price || !lastCheck.checkout_price) return null;
        const diff = lastCheck.checkout_price - offer.displayed_price;
        const pct = (diff / offer.displayed_price * 100).toFixed(1);
        return { diff: diff.toFixed(2), pct, isHigher: diff > 0 };
    };

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">RelevÃ©s de Prix</h1>
                    <p className="text-gray-500">DonnÃ©es capturÃ©es via l'extension Chrome</p>
                </div>
                <div className="flex items-center space-x-3">
                    <button
                        onClick={() => setConfigOpen(!configOpen)}
                        className="px-4 py-2 bg-dark-700 hover:bg-dark-600 rounded-lg font-medium transition flex items-center space-x-2"
                    >
                        <i className="fas fa-cog"></i>
                        <span>Configurer</span>
                    </button>
                    <button
                        onClick={loadOffers}
                        disabled={loading || !supabaseConfig.url}
                        className={`px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 ${
                            loading ? 'bg-gray-600 cursor-not-allowed' : 'bg-accent-green hover:bg-green-600'
                        }`}
                    >
                        {loading ? <><i className="fas fa-spinner fa-spin"></i><span>Chargement...</span></> : <><i className="fas fa-sync-alt"></i><span>Actualiser</span></>}
                    </button>
                </div>
            </div>

            {/* Config panel */}
            {configOpen && (
                <div className="glass rounded-xl border border-accent-blue/50 p-4 mb-6 bg-accent-blue/5">
                    <h3 className="font-semibold mb-3 flex items-center"><i className="fas fa-database text-accent-blue mr-2"></i>Configuration Supabase</h3>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">URL Supabase</label>
                            <input
                                type="text"
                                value={supabaseConfig.url}
                                onChange={(e) => setSupabaseConfig({...supabaseConfig, url: e.target.value})}
                                placeholder="https://xxxxx.supabase.co"
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm placeholder-gray-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">API Key (anon/public)</label>
                            <input
                                type="password"
                                value={supabaseConfig.key}
                                onChange={(e) => setSupabaseConfig({...supabaseConfig, key: e.target.value})}
                                placeholder="eyJhbGciOiJIUzI1NiIs..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm placeholder-gray-500"
                            />
                        </div>
                    </div>
                    <button onClick={saveConfig} className="px-4 py-2 bg-accent-blue hover:bg-blue-600 rounded-lg font-medium transition">
                        <i className="fas fa-save mr-2"></i>Sauvegarder et connecter
                    </button>
                </div>
            )}

            {/* Error */}
            {error && (
                <div className="glass rounded-xl border border-red-500/50 p-4 mb-6 bg-red-500/10">
                    <p className="text-red-400"><i className="fas fa-exclamation-triangle mr-2"></i>{error}</p>
                </div>
            )}

            {/* Stats */}
            {offers.length > 0 && (
                <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">Offres suivies</div>
                        <div className="text-2xl font-bold">{offers.length}</div>
                    </div>
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">RelevÃ©s total</div>
                        <div className="text-2xl font-bold">{offers.reduce((sum, o) => sum + (o.history?.length || 0), 0)}</div>
                    </div>
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">Avec Ã©cart &gt;5%</div>
                        <div className="text-2xl font-bold text-yellow-400">
                            {offers.filter(o => { const d = calcDiff(o); return d && Math.abs(parseFloat(d.pct)) > 5; }).length}
                        </div>
                    </div>
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">Stores</div>
                        <div className="text-2xl font-bold">{new Set(offers.map(o => o.store).filter(Boolean)).size}</div>
                    </div>
                </div>
            )}

            {/* Offers table */}
            {offers.length > 0 ? (
                <div className="glass rounded-xl border border-dark-600 overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-dark-700">
                            <tr>
                                <th className="text-left px-4 py-3 text-sm font-semibold">Offre</th>
                                <th className="text-left px-4 py-3 text-sm font-semibold">Store</th>
                                <th className="text-right px-4 py-3 text-sm font-semibold">Prix affichÃ©</th>
                                <th className="text-right px-4 py-3 text-sm font-semibold">Prix checkout</th>
                                <th className="text-right px-4 py-3 text-sm font-semibold">Ã‰cart</th>
                                <th className="text-center px-4 py-3 text-sm font-semibold">RelevÃ©s</th>
                                <th className="text-center px-4 py-3 text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-dark-600">
                            {offers.map(offer => {
                                const diff = calcDiff(offer);
                                const lastCheck = offer.history?.[0];
                                return (
                                    <tr key={offer.id} className="hover:bg-dark-700/50">
                                        <td className="px-4 py-3">
                                            <div className="font-medium truncate max-w-xs" title={offer.name}>{offer.name || 'Sans nom'}</div>
                                            <a href={offer.url} target="_blank" className="text-xs text-accent-blue hover:underline truncate block max-w-xs">{offer.url}</a>
                                        </td>
                                        <td className="px-4 py-3 text-gray-400">{offer.store || '-'}</td>
                                        <td className="px-4 py-3 text-right font-mono">
                                            {offer.displayed_price ? `${offer.displayed_price.toFixed(2)}â‚¬` : '-'}
                                        </td>
                                        <td className="px-4 py-3 text-right font-mono">
                                            {lastCheck?.checkout_price ? `${lastCheck.checkout_price.toFixed(2)}â‚¬` : '-'}
                                        </td>
                                        <td className="px-4 py-3 text-right">
                                            {diff ? (
                                                <span className={`font-semibold ${diff.isHigher ? 'text-red-400' : 'text-green-400'}`}>
                                                    {diff.isHigher ? '+' : ''}{diff.diff}â‚¬ ({diff.pct}%)
                                                </span>
                                            ) : '-'}
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <span className="px-2 py-1 bg-dark-600 rounded text-sm">{offer.history?.length || 0}</span>
                                        </td>
                                        <td className="px-4 py-3 text-center">
                                            <button
                                                onClick={() => setSelectedOffer(selectedOffer?.id === offer.id ? null : offer)}
                                                className="px-2 py-1 bg-accent-blue/20 text-accent-blue rounded text-xs hover:bg-accent-blue/30"
                                            >
                                                {selectedOffer?.id === offer.id ? 'Fermer' : 'Historique'}
                                            </button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            ) : !loading && !error && (
                <div className="glass rounded-xl border border-dark-600 p-8 text-center">
                    <i className="fas fa-inbox text-4xl text-gray-600 mb-4"></i>
                    <p className="text-gray-500">Aucune offre trouvÃ©e</p>
                    <p className="text-sm text-gray-600 mt-2">Utilisez l'extension Chrome pour capturer des prix</p>
                </div>
            )}

            {/* Detail modal */}
            {selectedOffer && (
                <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-semibold">
                            <i className="fas fa-history text-accent-blue mr-2"></i>
                            Historique: {selectedOffer.name || selectedOffer.url}
                        </h3>
                        {selectedOffer.displayed_price_screenshot && (
                            <a href={selectedOffer.displayed_price_screenshot} target="_blank" className="text-sm text-accent-blue hover:underline">
                                <i className="fas fa-image mr-1"></i>Screenshot
                            </a>
                        )}
                    </div>
                    {selectedOffer.history?.length > 0 ? (
                        <div className="space-y-2 max-h-64 overflow-auto">
                            {selectedOffer.history.map((check, i) => (
                                <div key={i} className="flex items-center justify-between p-3 bg-dark-700 rounded-lg">
                                    <div className="flex items-center space-x-4">
                                        <span className="text-sm text-gray-400">{new Date(check.check_date).toLocaleString('fr-FR')}</span>
                                        <span className="font-mono">{check.checkout_price?.toFixed(2)}â‚¬</span>
                                        {check.payment_method && <span className="text-xs text-gray-500">({check.payment_method})</span>}
                                    </div>
                                    {check.screenshot_url && (
                                        <a href={check.screenshot_url} target="_blank" className="text-accent-blue hover:underline text-sm">
                                            <i className="fas fa-external-link-alt"></i>
                                        </a>
                                    )}
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p className="text-gray-500 text-center py-4">Aucun relevÃ© pour cette offre</p>
                    )}
                </div>
            )}

            {/* Info */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>Comment Ã§a marche</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong>Extension Chrome</strong> : Clic droit sur un prix â†’ "Capture this price"</li>
                    <li>â€¢ <strong>CrÃ©er une offre</strong> : Clic droit â†’ "Add as offer to track"</li>
                    <li>â€¢ <strong>Mettre Ã  jour</strong> : Clic droit sur le prix checkout â†’ "Update offer price"</li>
                    <li>â€¢ <strong>DonnÃ©es</strong> : StockÃ©es dans Supabase, synchronisÃ©es ici</li>
                </ul>
            </div>
        </div>
    );
}

// ===== COUPON TRACKER - Tracking codes promo =====
function CouponTrackerPage() {
    const [coupons, setCoupons] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [showAddForm, setShowAddForm] = useState(false);
    const [newCoupon, setNewCoupon] = useState({
        code: '', vendor: '', promise: '', reality: '', game: '', source_url: '', notes: ''
    });
    const [supabaseConfig, setSupabaseConfig] = useState(() => {
        const saved = localStorage.getItem('ci_supabase_config');
        if (saved) try { return JSON.parse(saved); } catch(e) {}
        return {
            url: 'https://ngzvurmhqnanoghjyswh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nenZ1cm1ocW5hbm9naGp5c3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTc2MTIsImV4cCI6MjA4NDE3MzYxMn0.Sk9M-tUkZY5p0OPw7xT0UOaIgOR3SQRACSVyi_TL61Q'
        };
    });

    // Charger les coupons depuis Supabase
    const loadCoupons = async () => {
        if (!supabaseConfig.url || !supabaseConfig.key) return;
        setLoading(true);
        setError(null);
        try {
            const res = await fetch(`${supabaseConfig.url}/rest/v1/coupons?select=*&order=created_at.desc`, {
                headers: { 'apikey': supabaseConfig.key, 'Authorization': `Bearer ${supabaseConfig.key}` }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            setCoupons(await res.json());
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    // Ajouter un coupon
    const addCoupon = async () => {
        if (!newCoupon.code || !newCoupon.vendor) {
            setError('Code et vendeur requis');
            return;
        }
        setLoading(true);
        try {
            const res = await fetch(`${supabaseConfig.url}/rest/v1/coupons`, {
                method: 'POST',
                headers: {
                    'apikey': supabaseConfig.key,
                    'Authorization': `Bearer ${supabaseConfig.key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    code: newCoupon.code,
                    vendor: newCoupon.vendor,
                    promise: newCoupon.promise,
                    reality: newCoupon.reality,
                    game: newCoupon.game || null,
                    source_url: newCoupon.source_url || null,
                    notes: newCoupon.notes || null,
                    is_fake: newCoupon.reality && newCoupon.promise !== newCoupon.reality
                })
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            setShowAddForm(false);
            setNewCoupon({ code: '', vendor: '', promise: '', reality: '', game: '', source_url: '', notes: '' });
            loadCoupons();
        } catch (err) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    // Charger au mount
    useEffect(() => { loadCoupons(); }, []);

    // Stats
    const fakeCoupons = coupons.filter(c => c.is_fake);
    const vendors = [...new Set(coupons.map(c => c.vendor))];

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">RelevÃ©s de Coupons</h1>
                    <p className="text-gray-500">VÃ©rification des codes promo et rÃ©ductions</p>
                </div>
                <div className="flex items-center space-x-3">
                    <button
                        onClick={() => setShowAddForm(!showAddForm)}
                        className="px-4 py-2 bg-accent-purple hover:bg-purple-600 rounded-lg font-medium transition flex items-center space-x-2"
                    >
                        <i className="fas fa-plus"></i>
                        <span>Ajouter coupon</span>
                    </button>
                    <button
                        onClick={loadCoupons}
                        disabled={loading}
                        className={`px-4 py-2 rounded-lg font-medium transition flex items-center space-x-2 ${
                            loading ? 'bg-gray-600 cursor-not-allowed' : 'bg-accent-green hover:bg-green-600'
                        }`}
                    >
                        {loading ? <><i className="fas fa-spinner fa-spin"></i><span>Chargement...</span></> : <><i className="fas fa-sync-alt"></i><span>Actualiser</span></>}
                    </button>
                </div>
            </div>

            {/* Error */}
            {error && (
                <div className="glass rounded-xl border border-red-500/50 p-4 mb-6 bg-red-500/10">
                    <p className="text-red-400"><i className="fas fa-exclamation-triangle mr-2"></i>{error}</p>
                </div>
            )}

            {/* Add form */}
            {showAddForm && (
                <div className="glass rounded-xl border border-accent-purple/50 p-4 mb-6 bg-accent-purple/5">
                    <h3 className="font-semibold mb-4 flex items-center">
                        <i className="fas fa-ticket-alt text-accent-purple mr-2"></i>
                        Ajouter un relevÃ© de coupon
                    </h3>
                    <div className="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Code promo *</label>
                            <input
                                type="text"
                                value={newCoupon.code}
                                onChange={(e) => setNewCoupon({...newCoupon, code: e.target.value.toUpperCase()})}
                                placeholder="SAVE10"
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 font-mono"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Vendeur *</label>
                            <input
                                type="text"
                                value={newCoupon.vendor}
                                onChange={(e) => setNewCoupon({...newCoupon, vendor: e.target.value})}
                                placeholder="CDKeys, G2A..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Applicable sur (jeu)</label>
                            <input
                                type="text"
                                value={newCoupon.game}
                                onChange={(e) => setNewCoupon({...newCoupon, game: e.target.value})}
                                placeholder="Tout, EA FC 25..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Promesse affichÃ©e</label>
                            <input
                                type="text"
                                value={newCoupon.promise}
                                onChange={(e) => setNewCoupon({...newCoupon, promise: e.target.value})}
                                placeholder="-10%, -5â‚¬..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">RÃ©alitÃ© constatÃ©e</label>
                            <input
                                type="text"
                                value={newCoupon.reality}
                                onChange={(e) => setNewCoupon({...newCoupon, reality: e.target.value})}
                                placeholder="-3%, ExpirÃ©..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">URL source</label>
                            <input
                                type="url"
                                value={newCoupon.source_url}
                                onChange={(e) => setNewCoupon({...newCoupon, source_url: e.target.value})}
                                placeholder="https://..."
                                className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm"
                            />
                        </div>
                    </div>
                    <div className="mb-4">
                        <label className="block text-sm text-gray-400 mb-2">Notes</label>
                        <textarea
                            value={newCoupon.notes}
                            onChange={(e) => setNewCoupon({...newCoupon, notes: e.target.value})}
                            placeholder="Conditions non mentionnÃ©es, minimum d'achat cachÃ©..."
                            className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm h-20"
                        />
                    </div>
                    <div className="flex items-center justify-between">
                        <p className="text-sm text-gray-500">
                            <i className="fas fa-info-circle mr-1"></i>
                            Si "RÃ©alitÃ©" diffÃ¨re de "Promesse", le coupon sera marquÃ© comme trompeur
                        </p>
                        <div className="flex space-x-2">
                            <button onClick={() => setShowAddForm(false)} className="px-4 py-2 bg-dark-600 hover:bg-dark-500 rounded-lg">
                                Annuler
                            </button>
                            <button onClick={addCoupon} disabled={loading} className="px-4 py-2 bg-accent-purple hover:bg-purple-600 rounded-lg">
                                <i className="fas fa-save mr-2"></i>Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Stats */}
            {coupons.length > 0 && (
                <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">Coupons suivis</div>
                        <div className="text-2xl font-bold">{coupons.length}</div>
                    </div>
                    <div className="glass rounded-xl border border-dark-600 p-4">
                        <div className="text-sm text-gray-500 mb-1">Vendeurs</div>
                        <div className="text-2xl font-bold">{vendors.length}</div>
                    </div>
                    <div className="glass rounded-xl border border-red-500/30 p-4 bg-red-500/5">
                        <div className="text-sm text-red-400 mb-1"><i className="fas fa-exclamation-triangle mr-1"></i>Trompeurs</div>
                        <div className="text-2xl font-bold text-red-400">{fakeCoupons.length}</div>
                    </div>
                    <div className="glass rounded-xl border border-green-500/30 p-4 bg-green-500/5">
                        <div className="text-sm text-green-400 mb-1"><i className="fas fa-check-circle mr-1"></i>Valides</div>
                        <div className="text-2xl font-bold text-green-400">{coupons.length - fakeCoupons.length}</div>
                    </div>
                </div>
            )}

            {/* Coupons table */}
            {coupons.length > 0 ? (
                <div className="glass rounded-xl border border-dark-600 overflow-hidden">
                    <table className="w-full">
                        <thead className="bg-dark-700">
                            <tr>
                                <th className="text-left px-4 py-3 text-sm font-semibold">Code</th>
                                <th className="text-left px-4 py-3 text-sm font-semibold">Vendeur</th>
                                <th className="text-center px-4 py-3 text-sm font-semibold">Promesse</th>
                                <th className="text-center px-4 py-3 text-sm font-semibold">RÃ©alitÃ©</th>
                                <th className="text-left px-4 py-3 text-sm font-semibold">Applicable sur</th>
                                <th className="text-center px-4 py-3 text-sm font-semibold">Status</th>
                                <th className="text-right px-4 py-3 text-sm font-semibold">Date</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-dark-600">
                            {coupons.map(coupon => (
                                <tr key={coupon.id} className={`hover:bg-dark-700/50 ${coupon.is_fake ? 'bg-red-500/5' : ''}`}>
                                    <td className="px-4 py-3">
                                        <code className="px-2 py-1 bg-dark-600 rounded font-mono text-sm">{coupon.code}</code>
                                    </td>
                                    <td className="px-4 py-3 font-medium">{coupon.vendor}</td>
                                    <td className="px-4 py-3 text-center">
                                        <span className="text-green-400 font-semibold">{coupon.promise || '-'}</span>
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                        <span className={`font-semibold ${coupon.is_fake ? 'text-red-400' : 'text-green-400'}`}>
                                            {coupon.reality || coupon.promise || '-'}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-gray-400">{coupon.game || 'Tout'}</td>
                                    <td className="px-4 py-3 text-center">
                                        {coupon.is_fake ? (
                                            <span className="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded font-semibold">
                                                <i className="fas fa-times mr-1"></i>TROMPEUR
                                            </span>
                                        ) : (
                                            <span className="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded font-semibold">
                                                <i className="fas fa-check mr-1"></i>OK
                                            </span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-right text-sm text-gray-400">
                                        {coupon.created_at ? new Date(coupon.created_at).toLocaleDateString('fr-FR') : '-'}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            ) : !loading && (
                <div className="glass rounded-xl border border-dark-600 p-8 text-center">
                    <i className="fas fa-ticket-alt text-4xl text-gray-600 mb-4"></i>
                    <p className="text-gray-500">Aucun coupon relevÃ©</p>
                    <p className="text-sm text-gray-600 mt-2">Cliquez sur "Ajouter coupon" pour enregistrer un relevÃ©</p>
                </div>
            )}

            {/* Info */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-accent-blue mr-2"></i>Comment Ã§a marche</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong>Promesse</strong> : Ce que le comparateur ou le vendeur affiche (ex: -10%)</li>
                    <li>â€¢ <strong>RÃ©alitÃ©</strong> : Ce qui est rÃ©ellement appliquÃ© au checkout (ex: -3%)</li>
                    <li>â€¢ <strong>Trompeur</strong> : Quand la rÃ©alitÃ© ne correspond pas Ã  la promesse</li>
                    <li>â€¢ <strong>True Price Authority</strong> : Ces donnÃ©es alimentent la page "Faux Coupons"</li>
                </ul>
            </div>
        </div>
    );
}

function AlertsPage({ visibleAlerts = [], dismissAlert, clearAllAlerts, resetAlerts }) {
    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Toutes les alertes</h1>
                    <p className="text-gray-500">{visibleAlerts.length} alertes non lues</p>
                </div>
                <div className="flex items-center space-x-2">
                    {visibleAlerts.length > 0 && (
                        <button
                            onClick={clearAllAlerts}
                            className="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors flex items-center space-x-2"
                        >
                            <i className="fas fa-trash-alt"></i>
                            <span>Tout effacer</span>
                        </button>
                    )}
                    {visibleAlerts.length === 0 && recentAlerts.length > 0 && (
                        <button
                            onClick={resetAlerts}
                            className="px-4 py-2 bg-gray-500/20 text-gray-400 rounded-lg hover:bg-gray-500/30 transition-colors flex items-center space-x-2"
                        >
                            <i className="fas fa-undo"></i>
                            <span>RÃ©afficher tout</span>
                        </button>
                    )}
                </div>
            </div>

            {visibleAlerts.length === 0 ? (
                <div className="glass rounded-xl border border-dark-600 p-8 text-center">
                    <i className="fas fa-check-circle text-4xl text-green-400 mb-4"></i>
                    <p className="text-gray-400">Aucune alerte Ã  afficher</p>
                    <p className="text-sm text-gray-500 mt-2">Les alertes apparaÃ®tront via Sitemap Checker et Status Checker</p>
                </div>
            ) : (
                <div className="space-y-3">
                    {visibleAlerts.map(alert => (
                        <div key={alert.id} className={`glass rounded-xl border p-4 ${
                            alert.severity === 'high' ? 'border-red-500/50' :
                            alert.severity === 'medium' ? 'border-yellow-500/50' :
                            'border-dark-600'
                        }`}>
                            <div className="flex items-start justify-between">
                                <div className="flex items-start space-x-4">
                                    <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                        alert.type === 'price_drop' ? 'bg-green-500/20 text-green-400' :
                                        alert.type === 'new_feature' ? 'bg-purple-500/20 text-purple-400' :
                                        alert.type === 'sitemap' ? 'bg-blue-500/20 text-blue-400' :
                                        alert.type === 'promo' ? 'bg-yellow-500/20 text-yellow-400' :
                                        alert.type === 'seo' ? 'bg-orange-500/20 text-orange-400' :
                                        'bg-gray-500/20 text-gray-400'
                                    }`}>
                                        <i className={`fas ${
                                            alert.type === 'price_drop' ? 'fa-arrow-down' :
                                            alert.type === 'new_feature' ? 'fa-star' :
                                            alert.type === 'sitemap' ? 'fa-sitemap' :
                                            alert.type === 'promo' ? 'fa-tag' :
                                            alert.type === 'seo' ? 'fa-search' :
                                            'fa-bell'
                                        }`}></i>
                                    </div>
                                    <div>
                                        <div className="flex items-center space-x-2 mb-1">
                                            <span className="font-semibold">{alert.competitor}</span>
                                            <span className={`px-2 py-0.5 rounded text-xs ${
                                                alert.severity === 'high' ? 'bg-red-500/20 text-red-400' :
                                                alert.severity === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                                                'bg-gray-500/20 text-gray-400'
                                            }`}>{alert.severity}</span>
                                        </div>
                                        <p className="text-gray-300">{alert.message}</p>
                                        {alert.game && <p className="text-sm text-accent-blue mt-1"><i className="fas fa-gamepad mr-1"></i>{alert.game}</p>}
                                    </div>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <span className="text-sm text-gray-500">{alert.time}</span>
                                    <button
                                        onClick={() => dismissAlert(alert.id)}
                                        className="w-8 h-8 rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/40 hover:text-white transition-colors flex items-center justify-center"
                                        title="Marquer comme lu"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// ===== NEWS CHECKER =====
function NewsChecker() {
    const [filter, setFilter] = useState('all');
    const [sourceFilter, setSourceFilter] = useState('all');
    const [news, setNews] = useState([]);
    const [loading, setLoading] = useState(true);

    // Fetch real news data on mount
    useEffect(() => {
        fetchNewsFeeds().then(articles => {
            // Map API response to expected format
            const mappedNews = articles.map((a, idx) => ({
                id: a.id || idx,
                source: a.source || 'Unknown',
                title: a.title,
                url: a.url,
                publishedAt: a.publishedAt,
                category: a.category || 'news',
                views: Math.floor(Math.random() * 15000) + 1000, // Estimated
                discoverScore: (Math.random() * 3 + 6).toFixed(1) // Estimated 6-9
            }));
            setNews(mappedNews);
            setLoading(false);
        });
    }, []);

    // Use fetched news data
    const newsFeeds = news;

    // Calculer les stats
    const today = new Date();
    const todayNews = newsFeeds.filter(n => new Date(n.publishedAt).toDateString() === today.toDateString());
    const weekNews = newsFeeds.filter(n => (today - new Date(n.publishedAt)) / (1000*60*60*24) < 7);

    const ggdealsNews = newsFeeds.filter(n => n.source === 'GG.deals');
    const aksNews = newsFeeds.filter(n => n.source === 'AllKeyShop');
    const itadNews = newsFeeds.filter(n => n.source === 'IsThereAnyDeal');

    // Stats par source (articles/jour sur 7 jours)
    const ggArticlesPerDay = ggdealsNews.length > 0 ? (ggdealsNews.filter(n => (today - new Date(n.publishedAt)) / (1000*60*60*24) < 7).length / 7).toFixed(1) : '0';
    const aksArticlesPerDay = aksNews.length > 0 ? (aksNews.filter(n => (today - new Date(n.publishedAt)) / (1000*60*60*24) < 7).length / 7).toFixed(1) : '0';

    // Nombre de sources actives
    const activeSources = [ggdealsNews.length > 0, aksNews.length > 0, itadNews.length > 0].filter(Boolean).length;

    const filteredNews = newsFeeds
        .filter(n => sourceFilter === 'all' || n.source === sourceFilter)
        .filter(n => filter === 'all' || n.category === filter);

    const categories = [...new Set(newsFeeds.map(n => n.category))];

    const getCategoryColor = (cat) => {
        const colors = { sale: 'green', comparison: 'blue', bundle: 'purple', ranking: 'yellow', feature: 'pink', guide: 'orange', free: 'cyan', analysis: 'indigo' };
        return colors[cat] || 'gray';
    };

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">News Checker</h1>
                    <p className="text-gray-500">Veille Ã©ditoriale des comparateurs de prix</p>
                </div>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-5 gap-4 mb-6">
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Total articles</div>
                    <div className="text-2xl font-bold">{newsFeeds.length}</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Cette semaine</div>
                    <div className="text-2xl font-bold">{weekNews.length}</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Aujourd'hui</div>
                    <div className="text-2xl font-bold text-green-400">{todayNews.length}</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">Sources actives</div>
                    <div className="text-2xl font-bold">{activeSources}</div>
                </div>
                <div className="glass rounded-xl border border-dark-600 p-4">
                    <div className="text-sm text-gray-500 mb-1">CatÃ©gories</div>
                    <div className="text-2xl font-bold text-purple-400">{[...new Set(newsFeeds.map(n => n.category))].length}</div>
                </div>
            </div>

            {/* Source comparison - Dynamic based on available sources */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                {(() => {
                    // Get unique sources from newsFeeds
                    const sources = [...new Set(newsFeeds.map(n => n.source))];
                    const sourceConfig = {
                        'GG.deals': { logo: 'ðŸŸ¢', color: 'green', mainCat: 'sale' },
                        'AllKeyShop': { logo: 'ðŸ”µ', color: 'blue', mainCat: 'comparison' },
                        'IsThereAnyDeal': { logo: 'ðŸŸ¡', color: 'yellow', mainCat: 'sale' }
                    };
                    // Include all configured sources even if they have no data
                    const allSources = [...new Set([...Object.keys(sourceConfig), ...sources])];

                    return allSources.map(src => {
                        const config = sourceConfig[src] || { logo: 'âšª', color: 'gray', mainCat: 'news' };
                        const srcNews = newsFeeds.filter(n => n.source === src);
                        const weekSrcNews = srcNews.filter(n => (today - new Date(n.publishedAt)) / (1000*60*60*24) < 7);
                        const articlesPerDay = srcNews.length > 0 ? (weekSrcNews.length / 7).toFixed(1) : '0';
                        const mainCatCount = srcNews.filter(n => n.category === config.mainCat).length;

                        return (
                            <div key={src} className={`glass rounded-xl border border-${config.color}-500/30 p-4 bg-${config.color}-500/5`}>
                                <div className="flex items-center justify-between mb-3">
                                    <span className="font-semibold">{config.logo} {src}</span>
                                    <span className={`text-sm ${srcNews.length > 0 ? 'text-green-400' : 'text-red-400'}`}>{srcNews.length > 0 ? 'Actif' : 'Inactif'}</span>
                                </div>
                                <div className="grid grid-cols-3 gap-2 text-center text-sm">
                                    <div><div className="text-lg font-bold">{srcNews.length}</div><div className="text-gray-500">Articles</div></div>
                                    <div><div className="text-lg font-bold">{articlesPerDay}</div><div className="text-gray-500">Par jour</div></div>
                                    <div><div className="text-lg font-bold">{mainCatCount}</div><div className="text-gray-500">{config.mainCat === 'sale' ? 'Sales' : config.mainCat === 'comparison' ? 'Comparatifs' : 'News'}</div></div>
                                </div>
                            </div>
                        );
                    });
                })()}
            </div>

            {/* Filters - Dynamic sources based on actual data */}
            <div className="flex space-x-4 mb-4">
                <div className="flex space-x-2 flex-wrap gap-2">
                    <button onClick={() => setSourceFilter('all')} className={`px-3 py-1 rounded-lg text-sm ${sourceFilter === 'all' ? 'bg-accent-blue' : 'bg-dark-700 hover:bg-dark-600'}`}>
                        Toutes sources
                    </button>
                    {[...new Set(newsFeeds.map(n => n.source))].map(src => (
                        <button key={src} onClick={() => setSourceFilter(src)} className={`px-3 py-1 rounded-lg text-sm ${sourceFilter === src ? 'bg-accent-blue' : 'bg-dark-700 hover:bg-dark-600'}`}>
                            {src}
                        </button>
                    ))}
                </div>
                <div className="flex space-x-2">
                    <button onClick={() => setFilter('all')} className={`px-3 py-1 rounded-lg text-sm ${filter === 'all' ? 'bg-accent-blue' : 'bg-dark-700 hover:bg-dark-600'}`}>Tous</button>
                    {categories.map(cat => (
                        <button key={cat} onClick={() => setFilter(cat)} className={`px-3 py-1 rounded-lg text-sm ${filter === cat ? 'bg-accent-blue' : 'bg-dark-700 hover:bg-dark-600'}`}>{cat}</button>
                    ))}
                </div>
            </div>

            {/* News list */}
            <div className="glass rounded-xl border border-dark-600 overflow-hidden">
                <table className="w-full">
                    <thead className="bg-dark-700">
                        <tr>
                            <th className="text-left px-4 py-3 text-sm font-semibold">Article</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Source</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">CatÃ©gorie</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold">Vues</th>
                            <th className="text-center px-4 py-3 text-sm font-semibold">Discover</th>
                            <th className="text-right px-4 py-3 text-sm font-semibold">PubliÃ©</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-dark-600">
                        {filteredNews.map(news => (
                            <tr key={news.id} className="hover:bg-dark-700/50">
                                <td className="px-4 py-3">
                                    <a href={news.url} target="_blank" className="font-medium hover:text-accent-blue">{news.title}</a>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`px-2 py-1 rounded text-xs ${news.source === 'GG.deals' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`}>{news.source}</span>
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`px-2 py-1 rounded text-xs bg-${getCategoryColor(news.category)}-500/20 text-${getCategoryColor(news.category)}-400`}>{news.category}</span>
                                </td>
                                <td className="px-4 py-3 text-right font-mono">{(news.views/1000).toFixed(1)}K</td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`font-semibold ${news.discoverScore >= 8 ? 'text-green-400' : news.discoverScore >= 6 ? 'text-yellow-400' : 'text-gray-400'}`}>{news.discoverScore}</span>
                                </td>
                                <td className="px-4 py-3 text-right text-sm text-gray-400">
                                    {new Date(news.publishedAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
}

// ===== FEATURE CHECKER (Discord Feed) =====
function FeatureChecker() {
    const [features, setFeatures] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // Fetch real Discord announcements on mount
    useEffect(() => {
        fetchDiscordFeatures()
            .then(data => {
                setFeatures(data);
                setLoading(false);
            })
            .catch(err => {
                console.error('Error loading Discord features:', err);
                setError('Configuration Discord requise');
                setLoading(false);
            });
    }, []);

    const getStatusColor = (status) => {
        const colors = { released: 'green', beta: 'yellow', 'in-progress': 'blue', announced: 'purple' };
        return colors[status] || 'gray';
    };
    const getImpactColor = (impact) => {
        const colors = { critical: 'red', high: 'orange', medium: 'yellow', low: 'gray' };
        return colors[impact] || 'gray';
    };

    // Use fetched features data
    const discordFeatures = features;

    const releasedCount = discordFeatures.filter(f => f.status === 'released').length;
    const betaCount = discordFeatures.filter(f => f.status === 'beta').length;
    const announcedCount = discordFeatures.filter(f => f.status === 'announced').length;
    const inProgressCount = discordFeatures.filter(f => f.status === 'in-progress').length;

    return (
        <div>
            <div className="flex items-center justify-between mb-6">
                <div>
                    <h1 className="text-2xl font-bold">Feature Tracker</h1>
                    <p className="text-gray-500">Suivi des annonces Discord GG.deals</p>
                </div>
                <a href="https://discord.gg/ggdeals" target="_blank" className="px-4 py-2 bg-purple-500 rounded-lg font-medium hover:bg-purple-600 transition flex items-center space-x-2">
                    <i className="fab fa-discord"></i>
                    <span>Rejoindre le Discord</span>
                </a>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-4 gap-4 mb-6">
                <div className="glass rounded-xl border border-green-500/30 p-4 bg-green-500/5">
                    <div className="text-sm text-green-400 mb-1">Released</div>
                    <div className="text-2xl font-bold text-green-400">{releasedCount}</div>
                </div>
                <div className="glass rounded-xl border border-yellow-500/30 p-4 bg-yellow-500/5">
                    <div className="text-sm text-yellow-400 mb-1">Beta</div>
                    <div className="text-2xl font-bold text-yellow-400">{betaCount}</div>
                </div>
                <div className="glass rounded-xl border border-blue-500/30 p-4 bg-blue-500/5">
                    <div className="text-sm text-blue-400 mb-1">In Progress</div>
                    <div className="text-2xl font-bold text-blue-400">{inProgressCount}</div>
                </div>
                <div className="glass rounded-xl border border-purple-500/30 p-4 bg-purple-500/5">
                    <div className="text-sm text-purple-400 mb-1">Announced</div>
                    <div className="text-2xl font-bold text-purple-400">{announcedCount}</div>
                </div>
            </div>

            {/* Features timeline */}
            <div className="glass rounded-xl border border-dark-600 p-4">
                <h2 className="font-semibold mb-4"><i className="fas fa-stream mr-2 text-accent-blue"></i>Timeline des annonces</h2>

                {loading && (
                    <div className="text-center py-8 text-gray-400">
                        <i className="fas fa-spinner fa-spin text-2xl mb-3"></i>
                        <p>Chargement des annonces Discord...</p>
                    </div>
                )}

                {!loading && discordFeatures.length === 0 && (
                    <div className="text-center py-8 border border-dashed border-dark-600 rounded-lg">
                        <i className="fab fa-discord text-4xl text-purple-400 mb-3"></i>
                        <p className="text-gray-400 mb-2">Aucune annonce pour le moment</p>
                        <p className="text-sm text-gray-500 mb-4">Forward des annonces depuis les Discords concurrents vers ton channel #ci-announcements</p>
                        <div className="text-xs text-gray-600 bg-dark-700 rounded p-3 max-w-md mx-auto text-left">
                            <p className="font-semibold text-gray-400 mb-2">Format recommandÃ© :</p>
                            <code className="text-purple-400">[GG.deals] Titre de l'annonce</code><br/>
                            <code className="text-gray-500">Description de la feature</code><br/>
                            <code className="text-gray-500">#released #high-impact</code>
                        </div>
                    </div>
                )}

                <div className="space-y-4">
                    {!loading && discordFeatures.map(feature => (
                        <div key={feature.id} className={`p-4 rounded-lg border-l-4 bg-dark-700/50 border-${getStatusColor(feature.status)}-500`}>
                            <div className="flex items-start justify-between">
                                <div className="flex-1">
                                    <div className="flex items-center space-x-3 mb-2">
                                        <span className="font-semibold text-lg">{feature.title}</span>
                                        <span className={`px-2 py-0.5 rounded text-xs bg-${getStatusColor(feature.status)}-500/20 text-${getStatusColor(feature.status)}-400`}>{feature.status}</span>
                                        <span className={`px-2 py-0.5 rounded text-xs bg-${getImpactColor(feature.impact)}-500/20 text-${getImpactColor(feature.impact)}-400`}>Impact: {feature.impact}</span>
                                    </div>
                                    <p className="text-gray-400 mb-2">{feature.description}</p>
                                    <div className="flex items-center space-x-4 text-sm">
                                        <span className="text-gray-500"><i className="fas fa-calendar mr-1"></i>{new Date(feature.announcedAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                        <a href={feature.discordLink} target="_blank" className="text-purple-400 hover:underline"><i className="fab fa-discord mr-1"></i>Voir l'annonce</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* Format guide */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-info-circle text-blue-400 mr-2"></i>Sources Discord recommandÃ©es</h3>
                <div className="grid grid-cols-3 gap-4 text-sm">
                    <div className="bg-dark-700/50 p-3 rounded"><strong className="text-green-400">GG.deals</strong><br/><span className="text-gray-500">#announcements #changelog</span></div>
                    <div className="bg-dark-700/50 p-3 rounded"><strong className="text-yellow-400">IsThereAnyDeal</strong><br/><span className="text-gray-500">#news #updates</span></div>
                    <div className="bg-dark-700/50 p-3 rounded"><strong className="text-red-400">Fanatical</strong><br/><span className="text-gray-500">#announcements</span></div>
                </div>
            </div>

            {/* What to watch */}
            <div className="glass rounded-xl border border-dark-600 p-4 mt-6">
                <h3 className="font-semibold mb-3"><i className="fas fa-lightbulb text-yellow-400 mr-2"></i>OpportunitÃ©s dÃ©tectÃ©es</h3>
                <ul className="text-sm text-gray-400 space-y-2">
                    <li>â€¢ <strong className="text-red-400">Mobile App</strong> : GG.deals lance une app mobile - nous devons rÃ©agir</li>
                    <li>â€¢ <strong className="text-orange-400">API publique</strong> : Potentiel d'intÃ©gration ou de concurrence</li>
                    <li>â€¢ <strong className="text-yellow-400">Browser Extension</strong> : Ils dÃ©veloppent une extension similaire Ã  la nÃ´tre</li>
                </ul>
            </div>
        </div>
    );
}

// Composant pour activer/dÃ©sactiver le suivi des comparateurs
function ComparatorTrackingSettings() {
    // Ã‰tat pour chaque comparateur (dynamique basÃ© sur la liste des comparateurs)
    const [trackingState, setTrackingState] = useState(() => {
        const saved = localStorage.getItem('ci_comparator_tracking');
        if (saved) return JSON.parse(saved);
        // Par dÃ©faut, tous les comparateurs sont activÃ©s
        const defaultState = {};
        comparators.forEach(c => { defaultState[c.name] = true; });
        return defaultState;
    });

    const toggleTracking = (compName) => {
        const newState = { ...trackingState, [compName]: !trackingState[compName] };
        setTrackingState(newState);
        localStorage.setItem('ci_comparator_tracking', JSON.stringify(newState));
    };

    // Couleurs par comparateur
    const getColor = (name) => {
        const colors = {
            'AllKeyShop': 'blue',
            'GG.deals': 'green',
            'IsThereAnyDeal': 'yellow',
            'DLCompare': 'red',
            'CheapShark': 'purple'
        };
        return colors[name] || 'gray';
    };

    return (
        <div className="glass rounded-xl border border-dark-600 p-4">
            <h2 className="font-semibold mb-4"><i className="fas fa-eye mr-2"></i>Suivi des comparateurs</h2>
            <p className="text-sm text-gray-400 mb-4">Activez ou dÃ©sactivez le suivi pour chaque comparateur</p>
            <div className="space-y-3">
                {comparators.map(comp => {
                    const color = getColor(comp.name);
                    const isEnabled = trackingState[comp.name] !== false;
                    return (
                        <div key={comp.id} className={`flex items-center justify-between p-3 rounded-lg bg-dark-700 border ${isEnabled ? `border-${color}-500/30` : 'border-dark-600 opacity-50'}`}>
                            <div className="flex items-center space-x-3">
                                <span className="text-xl">{comp.logo}</span>
                                <div>
                                    <div className="font-medium">{comp.name}</div>
                                    <div className="text-xs text-gray-500">{comp.domain}</div>
                                </div>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                                <input
                                    type="checkbox"
                                    checked={isEnabled}
                                    onChange={() => toggleTracking(comp.name)}
                                    className="sr-only peer"
                                />
                                <div className={`w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-${color}-500`}></div>
                            </label>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

function SettingsPage() {
    const [webhookUrl, setWebhookUrl] = useState(() => localStorage.getItem('ci_discord_webhook') || '');
    const [discordEnabled, setDiscordEnabled] = useState(() => localStorage.getItem('ci_discord_enabled') === 'true');
    const [testStatus, setTestStatus] = useState('idle'); // idle, sending, success, error
    const [testError, setTestError] = useState('');

    // Sauvegarder les settings
    useEffect(() => {
        localStorage.setItem('ci_discord_webhook', webhookUrl);
        localStorage.setItem('ci_discord_enabled', discordEnabled.toString());
    }, [webhookUrl, discordEnabled]);

    // Envoyer un vrai message Discord
    const sendTestMessage = async () => {
        if (!webhookUrl || !webhookUrl.includes('discord.com/api/webhooks')) {
            setTestStatus('error');
            setTestError('URL webhook invalide');
            setTimeout(() => setTestStatus('idle'), 3000);
            return;
        }

        setTestStatus('sending');
        setTestError('');

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: 'CI War Room',
                    avatar_url: 'https://cdn-icons-png.flaticon.com/512/2111/2111370.png',
                    embeds: [{
                        title: 'ðŸŽ¯ Test CI War Room',
                        description: 'Connexion rÃ©ussie ! Les alertes seront envoyÃ©es sur ce canal.',
                        color: 0x5865F2,
                        fields: [
                            { name: 'ðŸ“Š Status', value: 'ConnectÃ©', inline: true },
                            { name: 'â° Date', value: new Date().toLocaleString('fr-FR'), inline: true }
                        ],
                        footer: { text: 'CI War Room - Gaming Keys Intelligence' }
                    }]
                })
            });

            if (response.ok || response.status === 204) {
                setTestStatus('success');
                setTimeout(() => setTestStatus('idle'), 3000);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            setTestStatus('error');
            setTestError(error.message || 'Erreur de connexion');
            setTimeout(() => setTestStatus('idle'), 5000);
        }
    };

    return (
        <div>
            <h1 className="text-2xl font-bold mb-6">ParamÃ¨tres</h1>
            <div className="space-y-6">
                {/* Discord Integration */}
                <div className="glass rounded-xl border border-purple-500/30 p-4 bg-purple-500/5">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="font-semibold flex items-center">
                            <i className="fab fa-discord text-purple-400 mr-2 text-xl"></i>
                            IntÃ©gration Discord
                        </h2>
                        <label className="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked={discordEnabled} onChange={() => setDiscordEnabled(!discordEnabled)} className="sr-only peer" />
                            <div className="w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                        </label>
                    </div>

                    {discordEnabled && (
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm text-gray-400 mb-2">Webhook URL</label>
                                <input
                                    type="text"
                                    value={webhookUrl}
                                    onChange={(e) => setWebhookUrl(e.target.value)}
                                    placeholder="https://discord.com/api/webhooks/..."
                                    className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm placeholder-gray-500"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <label className="flex items-center space-x-3 p-3 bg-dark-700 rounded-lg cursor-pointer hover:bg-dark-600">
                                    <input type="checkbox" defaultChecked className="w-4 h-4 accent-purple-500" />
                                    <div>
                                        <div className="text-sm font-medium">Alertes critiques</div>
                                        <div className="text-xs text-gray-500">Nouvelles menaces, prix cassÃ©s</div>
                                    </div>
                                </label>
                                <label className="flex items-center space-x-3 p-3 bg-dark-700 rounded-lg cursor-pointer hover:bg-dark-600">
                                    <input type="checkbox" defaultChecked className="w-4 h-4 accent-purple-500" />
                                    <div>
                                        <div className="text-sm font-medium">Status changes</div>
                                        <div className="text-xs text-gray-500">Services down/up</div>
                                    </div>
                                </label>
                                <label className="flex items-center space-x-3 p-3 bg-dark-700 rounded-lg cursor-pointer hover:bg-dark-600">
                                    <input type="checkbox" defaultChecked className="w-4 h-4 accent-purple-500" />
                                    <div>
                                        <div className="text-sm font-medium">Price drops</div>
                                        <div className="text-xs text-gray-500">Baisses de prix &gt;10%</div>
                                    </div>
                                </label>
                                <label className="flex items-center space-x-3 p-3 bg-dark-700 rounded-lg cursor-pointer hover:bg-dark-600">
                                    <input type="checkbox" className="w-4 h-4 accent-purple-500" />
                                    <div>
                                        <div className="text-sm font-medium">Daily report</div>
                                        <div className="text-xs text-gray-500">RÃ©sumÃ© quotidien 9h</div>
                                    </div>
                                </label>
                            </div>

                            <button
                                onClick={sendTestMessage}
                                disabled={!webhookUrl || testStatus === 'sending'}
                                className={`w-full py-2 rounded-lg font-medium transition flex items-center justify-center space-x-2 ${
                                    !webhookUrl ? 'bg-dark-600 text-gray-500 cursor-not-allowed' :
                                    testStatus === 'sending' ? 'bg-gray-600 cursor-wait' :
                                    testStatus === 'success' ? 'bg-green-500 text-white' :
                                    testStatus === 'error' ? 'bg-red-500 text-white' :
                                    'bg-purple-500 hover:bg-purple-600 text-white'
                                }`}
                            >
                                {testStatus === 'sending' ? (
                                    <><i className="fas fa-spinner fa-spin"></i><span>Envoi...</span></>
                                ) : testStatus === 'success' ? (
                                    <><i className="fas fa-check"></i><span>Message envoyÃ©!</span></>
                                ) : testStatus === 'error' ? (
                                    <><i className="fas fa-times"></i><span>{testError || 'Erreur'}</span></>
                                ) : (
                                    <><i className="fab fa-discord"></i><span>Envoyer un message test</span></>
                                )}
                            </button>
                        </div>
                    )}

                    {!discordEnabled && (
                        <p className="text-sm text-gray-500">Activez pour recevoir les alertes sur votre serveur Discord</p>
                    )}
                </div>

                {/* Suivi des comparateurs */}
                <ComparatorTrackingSettings />

                <div className="glass rounded-xl border border-dark-600 p-4">
                    <h2 className="font-semibold mb-4"><i className="fas fa-bell mr-2"></i>Notifications</h2>
                    <div className="space-y-3">
                        {[
                            { label: 'Alertes prix (baisse > 10%)', checked: true },
                            { label: 'Nouvelles pages sitemap (> 100/jour)', checked: true },
                            { label: 'Nouvelles promos concurrents', checked: true },
                            { label: 'Changements SEO majeurs', checked: false },
                            { label: 'Services offline/online', checked: true },
                            { label: 'Pages 404 dÃ©tectÃ©es', checked: true },
                        ].map((item, i) => (
                            <label key={i} className="flex items-center justify-between p-2 rounded hover:bg-dark-700 cursor-pointer">
                                <span className="text-sm">{item.label}</span>
                                <input type="checkbox" defaultChecked={item.checked} className="w-4 h-4 accent-accent-blue" />
                            </label>
                        ))}
                    </div>
                </div>

                <div className="glass rounded-xl border border-dark-600 p-4">
                    <h2 className="font-semibold mb-4"><i className="fas fa-clock mr-2"></i>FrÃ©quence des scans</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Sitemap Checker</label>
                            <select className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2">
                                <option>Toutes les heures</option>
                                <option>Toutes les 6 heures</option>
                                <option>Quotidien</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Status Checker</label>
                            <select className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2">
                                <option>Toutes les 15 minutes</option>
                                <option>Toutes les heures</option>
                                <option>Toutes les 6 heures</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Price Checker</label>
                            <select className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2">
                                <option>Toutes les heures</option>
                                <option>Toutes les 6 heures</option>
                                <option>Quotidien</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">Discord Reports</label>
                            <select className="w-full bg-dark-700 border border-dark-600 rounded-lg px-4 py-2">
                                <option>Temps rÃ©el</option>
                                <option>Digest horaire</option>
                                <option>Digest quotidien</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div className="glass rounded-xl border border-dark-600 p-4">
                    <h2 className="font-semibold mb-4"><i className="fas fa-server mr-2"></i>API & Webhooks</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm text-gray-400 mb-2">API Key (pour intÃ©grations externes)</label>
                            <div className="flex space-x-2">
                                <input type="text" value="ci_live_************************" readOnly className="flex-1 bg-dark-700 border border-dark-600 rounded-lg px-4 py-2 text-sm font-mono" />
                                <button className="px-4 py-2 bg-dark-600 hover:bg-dark-500 rounded-lg text-sm"><i className="fas fa-copy"></i></button>
                                <button className="px-4 py-2 bg-accent-blue hover:bg-blue-600 rounded-lg text-sm">RÃ©gÃ©nÃ©rer</button>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Data Mode Toggle */}
                <DataModeToggle />
            </div>
        </div>
    );
}

// Composant Toggle Mode DÃ©mo/RÃ©el
function DataModeToggle() {
    const [demoMode, setDemoMode] = useState(() => localStorage.getItem('ci_demo_mode') === 'true');

    const toggleMode = () => {
        const newMode = !demoMode;
        setDemoMode(newMode);
        localStorage.setItem('ci_demo_mode', newMode.toString());
        // Recharger la page pour appliquer les changements
        window.location.reload();
    };

    const clearAllData = () => {
        if (confirm('Effacer toutes les donnÃ©es locales ? (comparateurs, marchands, alertes, scans...)')) {
            const keysToRemove = ['ci_comparators', 'ci_merchants', 'ci_dismissed_alerts', 'ci_sitemap_data', 'ci_discord_webhook', 'ci_discord_enabled'];
            keysToRemove.forEach(key => localStorage.removeItem(key));
            window.location.reload();
        }
    };

    return (
        <div className="glass rounded-xl border border-orange-500/30 p-4 bg-orange-500/5">
            <div className="flex items-center justify-between mb-4">
                <h2 className="font-semibold flex items-center">
                    <i className="fas fa-flask text-orange-400 mr-2"></i>
                    Mode de donnÃ©es
                </h2>
                <div className="flex items-center space-x-3">
                    <span className={`text-sm ${!demoMode ? 'text-green-400 font-semibold' : 'text-gray-500'}`}>RÃ©el</span>
                    <label className="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" checked={demoMode} onChange={toggleMode} className="sr-only peer" />
                        <div className="w-11 h-6 bg-green-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                    </label>
                    <span className={`text-sm ${demoMode ? 'text-orange-400 font-semibold' : 'text-gray-500'}`}>DÃ©mo</span>
                </div>
            </div>

            <div className="text-sm text-gray-400 space-y-2 mb-4">
                {demoMode ? (
                    <div className="flex items-center text-orange-400">
                        <i className="fas fa-info-circle mr-2"></i>
                        Mode dÃ©mo actif : News Checker et Feature Tracker utilisent des donnÃ©es de test
                    </div>
                ) : (
                    <div className="flex items-center text-green-400">
                        <i className="fas fa-check-circle mr-2"></i>
                        Mode rÃ©el : DonnÃ©es en direct depuis les APIs (Discord, RSS)
                    </div>
                )}
            </div>

            <div className="flex items-center space-x-3">
                <button
                    onClick={clearAllData}
                    className="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition text-sm"
                >
                    <i className="fas fa-trash-alt mr-2"></i>
                    Effacer toutes les donnÃ©es locales
                </button>
            </div>
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
<!-- Cache bust: 1769868104 -->
